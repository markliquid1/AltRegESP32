<!-- X Engineering Alternator Regulator
    Copyright (C) 2025  Mark Nickerson

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

 See <https://www.gnu.org/licenses/> for GNU General Public License

Contact me at mark@xengineering.net       -->


<!DOCTYPE HTML>

<html>

<head>
  <meta charset="utf-8" />
  <title>X Engineering Alternator Regulator</title>
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <link href="/uPlot.min.css" rel="stylesheet" />
  <script src="/uPlot.iife.min.js">
    function syncToggleToHidden(name) {
      const checkbox = document.getElementById(name + "_checkbox");
      const hidden = document.getElementById(name);
      if (checkbox && hidden) {
        hidden.value = checkbox.checked ? "1" : "0";
        hidden.form.submit();
      }
    }
  </script>
  <style>
    :root {
      --primary: #333333;
      /* Dark gray primary */
      --accent: #ff6600;
      /* Orange accent */
      --bg-light: #f5f5f5;
      /* Very light gray background */
      --text-dark: #333333;
      /* Dark text */
      --text-light: #ffffff;
      /* Light text */
      --card-light: #ffffff;
      /* White card background */
      --border: #dddddd;
      /* Light border */
      --reading: #333333;
      /* Reading text color (changed from green) */
      --radius: 4px;
      /* Border radius */
    }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      padding: 0.5rem;
      background-color: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.4;
      font-size: 14px;
    }

    h2 {
      color: var(--text-dark);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 0.25rem;
      margin-top: 1rem;
      margin-bottom: 0.75rem;
      font-size: 18px;
    }

    input[type="submit"] {
      background-color: #555555;
      color: white;
      border: none;
      padding: 4px 10px;
      cursor: pointer;
      border-radius: var(--radius);
      font-weight: bold;
      width: 60px;
    }

    input[type="submit"]:hover {
      background-color: var(--accent);
    }

    input[type="text"],
    input[type="number"] {
      background: #ffffff;
      color: var(--text-dark);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 4px;
      width: 80px;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .card {
      background: var(--card-light);
      padding: 10px;
      border-left: 2px solid var(--accent);
      border-radius: var(--radius);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      margin-bottom: 4px;
    }

    .card p {
      margin: 0.25rem 0;
    }

    .card p:first-child {
      font-weight: bold;
      color: var(--text-dark);
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.25rem;
      margin-bottom: 0.25rem;
      font-size: 13px;
    }

    .reading {
      font-size: 1.1rem;
      font-weight: bold;
    }

    .reading span {
      color: var(--reading);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .settings-card {
      background: var(--card-light);
      border-radius: var(--radius);
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .section-title {
      background-color: #f0f0f0;
      color: var(--text-dark);
      padding: 6px 10px;
      margin: 0 0 10px 0;
      border-radius: var(--radius);
      font-weight: bold;
      border-left: 2px solid var(--accent);
      font-size: 14px;
    }

    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 8px 0;
    }


    .confirm-msg {
      transition: opacity 1s ease;
      opacity: 1;
    }

    .confirm-msg.fade-out {
      opacity: 0;
    }


    .form-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .form-label {
      flex: 1;
      text-align: left;
      padding-right: 10px;
    }

    .form-input {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) {
      .settings-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }

      body {
        font-size: 13px;
      }

      .grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }

    /* Toggle switch styling */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #2196F3;
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    .toggle-label {
      font-size: 0.9em;
      margin: 0 8px;
      vertical-align: middle;
    }

    .toggle-label {
      font-size: 0.9em;
      margin: 0 8px;
      vertical-align: middle;
    }



    .corner-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      border-radius: 10px;
      color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      z-index: 999;
      opacity: 0.9;
    }

    .corner-status-connected {
      background-color: #4CAF50;
    }

    .corner-status-disconnected {
      background-color: #F44336;
    }
  </style>


  <script>
    // Connection monitoring variables
    let lastEventTime = Date.now();
    const connectionCheckInterval = 10000; // Check every 10 seconds


    function submitMessage() {
      // console.log("Form submitted - values will update shortly");    // shut this off because it's "Console log spam" that might cause delay?
      // setTimeout(function () { document.location.reload(false); }, 500); // not needed anymore because
    }
  </script>
</head>

<body>
  <iframe name="hidden-form" style="display:none"></iframe>



  <h2>Security</h2>
  <div class="settings-grid">
    <div class="settings-card">
      <div class="section-title">Security</div>

      <div id="lock-status" style="font-weight:bold; color:#ff6600; margin-bottom:10px;">LOCKED</div>

      <div class="form-row">
        <div class="form-label">Enter Password:</div>
        <div class="form-input">
          <form action="/get" method="GET" target="hidden-form" onsubmit="setAdminPassword(); return false;"
            style="display: flex; justify-content: flex-end; align-items: center;">
            <input type="hidden" name="dummy" value="1" />
            <input type="password" id="admin_password" name="admin_password" style="width: 80px; margin-right: 8px;"
              autocomplete="current-password" />
            <input type="submit" id="admin_password_set" value="Set" />
            <span id="admin_password_msg" style="margin-left:8px; font-size:12px; color:green;"></span>
            <label style="margin-left: 8px; font-size: 12px;">
              <input type="checkbox" onclick="togglePassword('admin_password')"> Show
            </label>
          </form>
        </div>
      </div>

      <div class="form-row">
        <div class="form-label">New Password:</div>
        <div class="form-input">
          <form action="/setPassword" method="POST" target="hidden-form" onsubmit="return setNewPassword();"
            style="display: flex; justify-content: flex-end; align-items: center;">
            <input type="hidden" name="password" class="password_field">
            <input type="password" id="newpassword" name="newpassword" style="width: 80px; margin-right: 8px;" />
            <input type="submit" id="newpassword_set" value="Set" />
            <span id="newpassword_msg" style="margin-left:8px; font-size:12px; color:green;"></span>
            <label style="margin-left: 8px; font-size: 12px;">
              <input type="checkbox" onclick="togglePassword('newpassword')"> Show
            </label>
          </form>
        </div>
      </div>
      <div style="text-align: center; margin-top: 10px;">
        <input type="submit" id="lock-settings-button" onclick="lockSettingsManually(); return false;"
          value="Lock Settings" style="width: 120px; background-color: #ff6600;" />
      </div>


    </div>
  </div>

  <style>
    #lock-settings-button:hover {
      background-color: #b71c1c;
      /* Darker red on hover for the Lock Settings button */
    }
  </style>

  <script>
    function togglePassword(id) {
      var field = document.getElementById(id);
      field.type = (field.type === "password") ? "text" : "password";
    }
  </script>


  <h2>Settings</h2>

  <fieldset id="settings-section" disabled>
    <div class="settings-grid">

      <div class="settings-card">
        <div class="section-title">Basic Settings</div>
        <hr />
        <div class="form-row">
          <div class="form-label">Regulator Output (<span id="OnOff1_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="OnOff1_checkbox" type="checkbox"
                  onchange="document.getElementById('OnOff1').value = this.checked ? '1' : '0'; this.form.submit(); submitMessage();" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="OnOff1" name="OnOff1" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Charge Rate (<span id="HiLow1_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Low</span>
              <label class="switch">
                <input id="HiLow1_checkbox" type="checkbox"
                  onchange="document.getElementById('HiLow1').value = this.checked ? '1' : '0'; this.form.submit(); submitMessage();" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">High</span>
              <input id="HiLow1" name="HiLow1" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Limp Home Mode (<span id="LimpHome1_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="LimpHome1_checkbox" type="checkbox"
                  onchange="document.getElementById('LimpHome1').value = this.checked ? '1' : '0'; this.form.submit(); submitMessage();" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="LimpHome1" name="LimpHome1" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Switch Panel Override (<span id="0">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="SwitchControlOverride1_checkbox" type="checkbox"
                  onchange="document.getElementById('SwitchControlOverride1').value = this.checked ? '1' : '0'; this.form.submit(); submitMessage();" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="SwitchControlOverride1" name="SwitchControlOverride1" type="number"
                value="" style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Alternator Temp Limit (F) (<span id="TemperatureLimitF_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="TemperatureLimitF" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Bulk Voltage (<span id="FullChargeVoltage_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="FullChargeVoltage" type="number" step="0.01" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Charge Rate (A) (<span id="TargetAmpz_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="TargetAmpz" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Float Voltage (<span id="TargetFloatVoltage1_echo">0</span>):
          </div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="TargetFloatVoltage1" type="number" step="0.01" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
      </div>

      <div class="settings-card">
        <div class="section-title">Advanced Settings</div>
        <div class="form-row">
          <div class="form-label">Field Switch Freq (hz) (<span
              id="SwitchingFrequency_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="SwitchingFrequency" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Field Adj Step (V) (<span id="interval1_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="interval1" type="number" step="0.001" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Field Adj. Time Interval (ms) (<span
              id="FieldAdjustmentInterval1_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="FieldAdjustmentInterval1" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Manual Field Control (<span id="ManualFieldToggle1_echo"></span>):
          </div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="ManualFieldToggle1_checkbox" type="checkbox"
                  onchange="document.getElementById('ManualFieldToggle1').value = this.checked ? '1' : '0'; this.form.submit(); submitMessage();" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="ManualFieldToggle1" name="ManualFieldToggle1" type="number" value=""
                style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Manual Field Setpoint (V) (<span id="ManualVoltage_echo">0</span>):
          </div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="ManualVoltage" type="number" step="0.01" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
      </div>

      <div class="settings-card">
        <div class="section-title">System</div>
        <hr />
        <div class="form-row">
          <div class="form-label">VE.Direct Data (<span id="VeData1_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="VeData1_checkbox" type="checkbox"
                  onchange="document.getElementById('VeData1').value = this.checked ? '1' : '0'; this.form.submit(); submitMessage();" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="VeData1" name="VeData1" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">NMEA 0183 Data (<span id="NMEA0183Data1_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="NMEA0183Data1_checkbox" type="checkbox"
                  onchange="document.getElementById('NMEA0183Data1').value = this.checked ? '1' : '0'; this.form.submit(); submitMessage();" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="NMEA0183Data1" name="NMEA0183Data1" type="number" value=""
                style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">NMEA 2000 Data (<span id="NMEA2KData1_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="NMEA2KData1_checkbox" type="checkbox"
                  onchange="document.getElementById('NMEA2KData1').value = this.checked ? '1' : '0'; this.form.submit(); submitMessage();" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="NMEA2KData1" name="NMEA2KData1" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
      </div>

    </div>
  </fieldset>

  <h2>Live Data</h2>
  <div class="settings-grid">

    <div class="settings-card">
      <div class="section-title">Battery</div>
      <div class="grid">
        <div class="card">
          <p>ADS Battery Voltage</p>
          <p class="reading"><span id="BatteryVID">0</span> V</p>
        </div>
        <div class="card">
          <p>Victron Battery Voltage</p>
          <p class="reading"><span id="VictronVoltageID">0</span> V</p>
        </div>
        <div class="card">
          <p>INA Battery Voltage</p>
          <p class="reading"><span id="IBVID">0</span> V</p>
        </div>
        <div class="card">
          <p>INA Max Battery Voltage</p>
          <p class="reading"><span id="IBVMaxID">0</span> V</p>
        </div>
        <div class="card">
          <p>State of Charge</p>
          <p class="reading"><span id="SoC_percentID">0</span> %</p>
        </div>
        <div class="card">
          <p>Battery Charged Energy</p>
          <p class="reading"><span id="ChargedEnergyID">0</span> Wh</p>
        </div>
        <div class="card">
          <p>Discharged Energy</p>
          <p class="reading"><span id="DischargedEnergyID">0</span> Wh</p>
        </div>
        <div class="card">
          <p>Battery Current</p>
          <p class="reading"><span id="BCurrID">0</span> A</p>
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="section-title">Alternator</div>
      <div class="grid">
        <div class="card">
          <p>ADS Alternator Current</p>
          <p class="reading"><span id="MeasAmpsID">0</span> A</p>
        </div>
        <div class="card">
          <p>Alternator Temperature</p>
          <p class="reading"><span id="AltTempID">0</span> °F</p>
        </div>
        <div class="card">
          <p>Field Duty Cycle</p>
          <p class="reading"><span id="DutyCycleID">0</span> %</p>
        </div>
        <div class="card">
          <p>Field Voltage</p>
          <p class="reading"><span id="FieldVoltsID">0</span> V</p>
        </div>
        <div class="card">
          <p>Field Current</p>
          <p class="reading"><span id="FieldAmpsID">0</span> A</p>
        </div>
        <div class="card">
          <p>Alternator On Time</p>
          <p class="reading"><span id="AlternatorOnTimeID">0</span> H:M:S</p>
        </div>
        <div class="card">
          <p>Fuel Used</p>
          <p class="reading"><span id="AlternatorFuelUsedID">0</span> mL</p>
        </div>
        <div class="card">
          <p>Alternator Charged Energy</p>
          <p class="reading"><span id="AlternatorChargedEnergyID">0</span> Wh</p>
        </div>
        <div class="card">
          <p>Max Output Current</p>
          <p class="reading"><span id="MeasuredAmpsMaxID">0</span> A</p>
        </div>
        <div class="card">
          <p>Max Alternator Temp</p>
          <p class="reading"><span id="MaxAlternatorTemperatureF_ID">0</span> °F</p>
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="section-title">Engine</div>
      <div class="grid">
        <div class="card">
          <p>Engine Speed</p>
          <p class="reading"><span id="RPMID">0</span> rev/min</p>
        </div>
        <div class="card">
          <p>Engine Run Time</p>
          <p class="reading"><span id="EngineRunTimeID">0</span> H:M:S</p>
        </div>
        <div class="card">
          <p>Engine Rev Counter</p>
          <p class="reading"><span id="EngineCyclesID">0</span> rotations</p>
        </div>
        <div class="card">
          <p>Max RPM</p>
          <p class="reading"><span id="RPMMaxID">0</span> rev/min</p>
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="section-title">ESP32 Monitor</div>
      <div class="grid">
        <div class="card">
          <p>Loop Time</p>
          <p class="reading"><span id="LoopTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>Maximum Loop Time</p>
          <p class="reading"><span id="MaximumLoopTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>Analog Read Time (Max)</p>
          <p class="reading"><span id="AnalogReadTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>Wifi Send Time</p>
          <p class="reading"><span id="SendWifiTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>VE Dir. Read Time</p>
          <p class="reading"><span id="VeTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>Wifi Strength</p>
          <p class="reading"><span id="WifiStrengthID">0</span> dB</p>
        </div>
        <div class="card">
          <p>Wifi Heartbeat</p>
          <p class="reading"><span id="WifiHeartBeatID">0</span> #</p>
        </div>
        <div class="card">
          <p>Free Heap Memory</p>
          <p class="reading"><span id="FreeHeapID">0</span> kb</p>
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="section-title">Other</div>
      <div class="grid">
        <div class="card">
          <p>GPS Heading</p>
          <p class="reading"><span id="GPSHID">0</span> °</p>
        </div>
        <div class="card">
          <p>ADS Ch3 Voltage</p>
          <p class="reading"><span id="ADS3ID">0</span> V</p>
        </div>
      </div> <!-- Closes .grid -->
    </div> <!-- Closes settings-card (Other) -->
  </div> <!-- CLOSE settings-grid for Live Data -->



  <h2>Plots</h2>

  <div class="settings-card">
    <div class="section-title">Current and Temperature History</div>
    <div class="plot-container" id="current-temp-plot"></div>
  </div>
  <div class="settings-card">
    <div class="section-title">Battery Voltage History</div>
    <div class="plot-container" id="voltage-plot"></div>
  </div>


  <div class="settings-card">
    <div class="section-title">RPM History</div>
    <div class="plot-container" id="rpm-plot"></div>
  </div>

  <div class="settings-card">
    <div class="section-title">Client Update Time History</div>
    <div class="plot-container" id="client-update-plot"></div>
  </div>

  <div class="settings-card">
    <div class="section-title">WiFi Signal Strength History</div>
    <div class="plot-container" id="wifi-plot"></div>
  </div>


  <script>
    function debounce(fn, delay) {
      let timer = null;
      return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    let currentAdminPassword = "";

    function updatePasswordFields() {
      const password = currentAdminPassword || document.getElementById("admin_password").value;
      const passwordFields = document.querySelectorAll('.password_field');
      passwordFields.forEach(field => {
        field.value = password;
      });
    }



    const fieldIndexes = {
      AlternatorTemperatureF: 0,
      DutyCycle: 1,
      BatteryV: 2,
      MeasuredAmps: 3,
      RPM: 4,
      Channel3V: 5,
      IBV: 6,
      Bcur: 7,
      VictronVoltage: 8,
      LoopTime: 9,
      WifiStrength: 10,
      WifiHeartBeat: 11,
      SendWifiTime: 12,
      AnalogReadTime: 13,
      VeTime: 14,
      MaximumLoopTime: 15,
      HeadingNMEA: 16,
      vvout: 17,
      iiout: 18,
      FreeHeap: 19,
      IBVMax: 20,
      MeasuredAmpsMax: 21,
      RPMMax: 22,
      SoC_percent: 23,
      EngineRunTime: 24,
      EngineCycles: 25,
      AlternatorOnTime: 26,
      AlternatorFuelUsed: 27,
      ChargedEnergy: 28,
      DischargedEnergy: 29,
      AlternatorChargedEnergy: 30,
      MaxAlternatorTemperatureF: 31,
      TemperatureLimitF: 32,
      FullChargeVoltage: 33,
      TargetAmpz: 34,
      TargetFloatVoltage1: 35,
      SwitchingFrequency: 36,
      interval1: 37,
      FieldAdjustmentInterval1: 38,
      ManualVoltage: 39,
      SwitchControlOverride1: 40,
      OnOff1: 41,
      ManualFieldToggle1: 42,
      HiLow1: 43,
      LimpHome1: 44,
      VeData1: 45,
      NMEA0183Data1: 46,
      NMEA2KData1: 47
    };



    function updateInlineStatus(isConnected) {
      const cornerStatus = document.getElementById('corner-status');

      if (cornerStatus) {
        if (isConnected) {
          cornerStatus.className = 'corner-status corner-status-connected';
          cornerStatus.textContent = 'CONNECTED';
        } else {
          cornerStatus.className = 'corner-status corner-status-disconnected';
          cornerStatus.textContent = 'DISCONNECTED';
        }
      }
    }

    // WiFi Signal Plot Data
    const wifiData = [[], []];
    let uplot;

    // Client Update Time Plot Data
    const clientUpdateData = [[], []];
    let clientUpdatePlot;
    let lastClientUpdateTime = 0;

    // Current and Temperature Plot Data
    // [timestamps, battery current, alternator current, field current, alt temp]
    const currentTempData = [[], [], [], [], []];
    let currentTempPlot;

    // Voltage Plot Data
    // [timestamps, ADS Battery V, Victron Battery V, INA Battery V]
    const voltageData = [[], [], [], []];
    let voltagePlot;

    // RPM Plot Data
    const rpmData = [[], []];
    let rpmPlot;


    const maxPoints = 20;
    let lastPlotUpdate = 0; // Timestamp of last time we updated the plot
    const PLOT_UPDATE_INTERVAL_MS = 1000; // Only update every 2 seconds (adjust as needed)


    function schedulePlotUpdate() {
      if (!window.updateScheduled) {
        window.updateScheduled = true;

        requestAnimationFrame(() => {
          uplot.setData(wifiData);
          window.updateScheduled = false;

        });
      }
    }

    function scheduleClientUpdatePlotUpdate() {
      if (!window.clientUpdateScheduled && clientUpdatePlot) {
        window.clientUpdateScheduled = true;
        requestAnimationFrame(() => {
          clientUpdatePlot.setData(clientUpdateData);
          window.clientUpdateScheduled = false;
        });
      }
    }

    function scheduleCurrentTempPlotUpdate() {
      if (!window.currentTempUpdateScheduled && currentTempPlot) {
        window.currentTempUpdateScheduled = true;
        requestAnimationFrame(() => {
          currentTempPlot.setData(currentTempData);
          window.currentTempUpdateScheduled = false;
        });
      }
    }

    function scheduleVoltagePlotUpdate() {
      if (!window.voltageUpdateScheduled && voltagePlot) {
        window.voltageUpdateScheduled = true;
        requestAnimationFrame(() => {
          voltagePlot.setData(voltageData);
          window.voltageUpdateScheduled = false;
        });
      }
    }

    function scheduleRPMPlotUpdate() {
      if (!window.rpmUpdateScheduled && rpmPlot) {
        window.rpmUpdateScheduled = true;
        requestAnimationFrame(() => {
          rpmPlot.setData(rpmData);
          window.rpmUpdateScheduled = false;
        });
      }
    }


    function initWifiPlot() {
      const plotEl = document.getElementById('wifi-plot');
      if (!plotEl) {
        console.error("WiFi plot element not found");
        return;
      }

      const opts = {
        width: plotEl.clientWidth,
        height: 300,
        title: "WiFi Signal Strength",
        series: [
          {},
          {
            label: "Signal Strength (dB)",
            stroke: "#ff6600",
            width: 2,
            scale: "strength"
          }
        ],
        axes: [
          {},
          {
            scale: "strength",
            label: "dB",
            grid: { show: true }
          }
        ],
        scales: {
          x: { time: true },
          strength: {
            auto: true,
            range: [-90, -30]
          }
        },
        plugins: [{
          hooks: {
            init: [
              (u) => {
                const resizePlot = debounce(() => {
                  const plotEl = document.getElementById("wifi-plot");
                  if (plotEl && uplot) {
                    uplot.setSize({ width: plotEl.clientWidth, height: 300 });
                  }
                }, 1000);  // Delay resizing until 1s after changes stop
                const ro = new ResizeObserver(resizePlot);
                ro.observe(plotEl);
              }
            ]
          }
        }]
      };

      uplot = new uPlot(opts, wifiData, plotEl);
      const startTime = Math.floor(Date.now() / 1000);
      wifiData[0].push(startTime);
      wifiData[1].push(-65);
      uplot.setData(wifiData);
    }

    // Check for client stability 
    function initClientUpdatePlot() {
      const plotEl = document.getElementById('client-update-plot');
      if (!plotEl) {
        console.error("Client Update plot element not found");
        return;
      }

      const opts = {
        width: plotEl.clientWidth,
        height: 300,
        title: "Client Update Time",
        series: [
          {}, // timestamps
          {
            label: "Update Time (ms)",
            stroke: "#009688", // Teal
            width: 2,
            scale: "time"
          }
        ],
        axes: [
          {},
          {
            scale: "time",
            label: "ms",
            grid: { show: true }
          }
        ],
        scales: {
          x: { time: true },
          time: { auto: true }
        },
        plugins: [{
          hooks: {
            init: [
              (u) => {
                const resizePlot = debounce(() => {
                  const plotEl = document.getElementById("client-update-plot");
                  if (plotEl && clientUpdatePlot) {
                    clientUpdatePlot.setSize({ width: plotEl.clientWidth, height: 300 });
                  }
                }, 1000);
                const ro = new ResizeObserver(resizePlot);
                ro.observe(plotEl);
              }
            ]
          }
        }]
      };

      clientUpdatePlot = new uPlot(opts, clientUpdateData, plotEl);
      const startTime = Math.floor(Date.now() / 1000);
      clientUpdateData[0].push(startTime);
      clientUpdateData[1].push(0);
      clientUpdatePlot.setData(clientUpdateData);
    }



    function initCurrentTempPlot() {
      const plotEl = document.getElementById('current-temp-plot');
      if (!plotEl) {
        console.error("Current & Temperature plot element not found");
        return;
      }

      const opts = {
        width: plotEl.clientWidth,
        height: 300,
        title: "Current & Temperature History",
        series: [
          {}, // timestamps
          {
            label: "Battery Current (A)",
            stroke: "#4CAF50",
            width: 2,
            scale: "current"
          },
          {
            label: "Alternator Current (A)",
            stroke: "#2196F3",
            width: 2,
            scale: "current"
          },
          {
            label: "Field Current (A)",
            stroke: "#9C27B0",
            width: 2,
            scale: "current"
          },
          {
            label: "Alt. Temp (°F)",
            stroke: "#FF5722",
            width: 2,
            scale: "current"  // <-- Temperature now uses same Y-axis as current
          }
        ],
        axes: [
          {}, // x-axis (time)
          {
            scale: "current",
            label: "Amperes / °F",
            grid: { show: true },
            side: 3
          }
        ],
        scales: {
          x: { time: true },
          current: {
            auto: true
          }
        },
        plugins: [{
          hooks: {
            init: [
              (u) => {
                const resizePlot = debounce(() => {
                  const plotEl = document.getElementById("current-temp-plot");
                  if (plotEl && currentTempPlot) {
                    currentTempPlot.setSize({ width: plotEl.clientWidth, height: 300 });
                  }
                }, 1000);
                const ro = new ResizeObserver(resizePlot);
                ro.observe(plotEl);
              }
            ]
          }
        }]
      };

      currentTempPlot = new uPlot(opts, currentTempData, plotEl);
      const startTime = Math.floor(Date.now() / 1000);
      currentTempData[0].push(startTime);
      currentTempData[1].push(0);
      currentTempData[2].push(0);
      currentTempData[3].push(0);
      currentTempData[4].push(100); // Initial temperature value
      currentTempPlot.setData(currentTempData);
    }



    function initVoltagePlot() {
      const plotEl = document.getElementById('voltage-plot');
      if (!plotEl) {
        console.error("Voltage plot element not found");
        return;
      }

      const opts = {
        width: plotEl.clientWidth,
        height: 300,
        title: "Battery Voltage History",
        series: [
          {},
          {
            label: "ADS Battery (V)",
            stroke: "#FF9800", // Orange
            width: 2,
            scale: "voltage"
          },
          {
            label: "Victron Battery (V)",
            stroke: "#3F51B5", // Indigo
            width: 2,
            scale: "voltage"
          },



          {
            label: "INA Battery (V)",
            stroke: "#607D8B", // Blue Grey
            width: 2,
            scale: "voltage"
          }
        ],
        axes: [
          {},
          {
            scale: "voltage",
            label: "Volts",
            grid: { show: true }
          }
        ],
        scales: {
          x: { time: true },
          voltage: {
            auto: true,
          }
        },
        plugins: [{
          hooks: {
            init: [
              (u) => {
                const resizePlot = debounce(() => {
                  const plotEl = document.getElementById("voltage-plot");
                  if (plotEl && voltagePlot) {
                    voltagePlot.setSize({ width: plotEl.clientWidth, height: 300 });
                  }
                }, 1000);
                const ro = new ResizeObserver(resizePlot);
                ro.observe(plotEl);
              }
            ]
          }
        }]
      };

      voltagePlot = new uPlot(opts, voltageData, plotEl);
      const startTime = Math.floor(Date.now() / 1000);
      voltageData[0].push(startTime);
      voltageData[1].push(0);
      voltageData[2].push(0);
      voltageData[3].push(0);
      voltagePlot.setData(voltageData);
    }

    function initRPMPlot() {
      const plotEl = document.getElementById('rpm-plot');
      if (!plotEl) {
        console.error("RPM plot element not found");
        return;
      }

      const opts = {
        width: plotEl.clientWidth,
        height: 300,
        title: "RPM History",
        series: [
          {}, // timestamps
          {
            label: "RPM",
            stroke: "#E91E63",
            width: 2,
            scale: "rpm"
          }
        ],
        axes: [
          {},
          {
            scale: "rpm",
            label: "rev/min",
            grid: { show: true }
          }
        ],
        scales: {
          x: { time: true },
          rpm: { auto: true }
        },
        plugins: [{
          hooks: {
            init: [
              (u) => {
                const resizePlot = debounce(() => {
                  const plotEl = document.getElementById("rpm-plot");
                  if (plotEl && rpmPlot) {
                    rpmPlot.setSize({ width: plotEl.clientWidth, height: 300 });
                  }
                }, 1000);
                const ro = new ResizeObserver(resizePlot);
                ro.observe(plotEl);
              }
            ]
          }
        }]
      };

      rpmPlot = new uPlot(opts, rpmData, plotEl);
      const startTime = Math.floor(Date.now() / 1000);
      rpmData[0].push(startTime);
      rpmData[1].push(0);
      rpmPlot.setData(rpmData);
    }

    function setAdminPassword() {
      const button = document.getElementById('admin_password_set');
      const input = document.getElementById('admin_password');
      const msg = document.getElementById('admin_password_msg');
      const password = input.value;

      if (!password) {
        msg.textContent = "Missing Password";
        msg.style.color = "#ff6600";
        setTimeout(() => { msg.textContent = ""; }, 2000);
        return false;
      }

      button.disabled = true;

      const formData = new FormData();
      formData.append("password", password);

      fetch("/checkPassword", {
        method: "POST",
        body: formData
      })
        .then(response => response.text())
        .then(text => {
          if (text.trim() === "OK") {
            currentAdminPassword = password;
            // Unlock settings
            const settingsSection = document.getElementById('settings-section');
            if (settingsSection) {
              settingsSection.disabled = false;
            }
            const lockStatus = document.getElementById('lock-status');
            if (lockStatus) {
              lockStatus.textContent = "Settings are Open";
              lockStatus.style.color = "green";
            }

            updatePasswordFields();
            msg.textContent = "Password Accepted";
            msg.style.color = "green";
          } else {
            msg.textContent = "Wrong Password";
            msg.style.color = "#ff6600";
          }
          input.value = "";
          setTimeout(() => { msg.textContent = ""; button.disabled = false; }, 2000);
        })
        .catch(err => {
          msg.textContent = "Error";
          msg.style.color = "#ff6600";
          setTimeout(() => { msg.textContent = ""; button.disabled = false; }, 2000);
        });

      return false;
    }

    function lockSettingsManually() {
      const settingsSection = document.getElementById('settings-section');
      const lockStatus = document.getElementById('lock-status');

      if (settingsSection) settingsSection.disabled = true;
      if (lockStatus) {
        lockStatus.textContent = "Settings are Locked";
        lockStatus.style.color = "#ff6600";  // Your house orange
      }
      currentAdminPassword = "";
    }

    function setNewPassword() {
      const button = document.getElementById('newpassword_set');
      const input = document.getElementById('newpassword');
      const msg = document.getElementById('newpassword_msg');
      const currentPassword = currentAdminPassword;

      if (!currentPassword || !input.value) {
        msg.textContent = "Missing fields";
        msg.style.color = "#ff6600";
        setTimeout(() => { msg.textContent = ""; }, 2000);
        return false;
      }

      button.disabled = true;

      const formData = new FormData();
      formData.append("password", currentPassword);
      formData.append("newpassword", input.value);

      fetch("/setPassword", {
        method: "POST",
        body: formData
      })
        .then(response => response.text())
        .then(text => {
          if (text.trim() === "OK") {
            msg.textContent = "Password Changed";
            msg.style.color = "green";
          } else {
            msg.textContent = "Wrong Password";
            msg.style.color = "#ff6600";
          }
          input.value = "";
          setTimeout(() => { msg.textContent = ""; button.disabled = false; }, 2000);
        })
        .catch(err => {
          msg.textContent = "Error";
          msg.style.color = "#ff6600";
          setTimeout(() => { msg.textContent = ""; button.disabled = false; }, 2000);
        });

      return false; // prevent form submit
    }






    window.addEventListener("load", function () {
      //gray out Settings on a reload
      const settingsSection = document.getElementById('settings-section');
      if (settingsSection) {
        settingsSection.disabled = true;
      }
      const lockStatus = document.getElementById('lock-status');
      if (lockStatus) {
        lockStatus.textContent = "Settings are Locked";
        lockStatus.style.color = "#ff6600";  //  My house orange
      }
      initWifiPlot();
      initCurrentTempPlot();
      initVoltagePlot();
      initRPMPlot();
      initClientUpdatePlot();
      if (!!window.EventSource) {
        const telemetryFields = [
          ["AltTempID", "AlternatorTemperatureF"],
          ["DutyCycleID", "DutyCycle"],
          ["BatteryVID", "BatteryV"],
          ["MeasAmpsID", "MeasuredAmps"],
          ["RPMID", "RPM"],
          ["ADS3ID", "Channel3V"],
          ["IBVID", "IBV"],
          ["BCurrID", "Bcur"],
          ["VictronVoltageID", "VictronVoltage"],
          ["LoopTimeID", "LoopTime"],
          ["WifiStrengthID", "WifiStrength"],
          ["WifiHeartBeatID", "WifiHeartBeat"],
          ["SendWifiTimeID", "SendWifiTime"],
          ["AnalogReadTimeID", "AnalogReadTime"],
          ["VeTimeID", "VeTime"],
          ["MaximumLoopTimeID", "MaximumLoopTime"],
          ["GPSHID", "HeadingNMEA"],
          ["FieldVoltsID", "vvout"],
          ["FieldAmpsID", "iiout"],
          ["FreeHeapID", "FreeHeap"],
          ["IBVMaxID", "IBVMax"],
          ["MeasuredAmpsMaxID", "MeasuredAmpsMax"],
          ["RPMMaxID", "RPMMax"],
          ["SoC_percentID", "SoC_percent"],
          ["EngineRunTimeID", "EngineRunTime"],
          ["EngineCyclesID", "EngineCycles"],
          ["AlternatorOnTimeID", "AlternatorOnTime"],
          ["AlternatorFuelUsedID", "AlternatorFuelUsed"],
          ["ChargedEnergyID", "ChargedEnergy"],
          ["DischargedEnergyID", "DischargedEnergy"],
          ["AlternatorChargedEnergyID", "AlternatorChargedEnergy"],
          ["MaxAlternatorTemperatureF_ID", "MaxAlternatorTemperatureF"]
        ];

        const controlEchoFields = [
          ["TemperatureLimitF_echo", "TemperatureLimitF"],
          ["FullChargeVoltage_echo", "FullChargeVoltage"],
          ["TargetAmpz_echo", "TargetAmpz"],
          ["TargetFloatVoltage1_echo", "TargetFloatVoltage1"],
          ["SwitchingFrequency_echo", "SwitchingFrequency"],
          ["interval1_echo", "interval1"],
          ["FieldAdjustmentInterval1_echo", "FieldAdjustmentInterval1"],
          ["ManualVoltage_echo", "ManualVoltage"],
          ["SwitchControlOverride1_echo", "SwitchControlOverride1"],
          ["OnOff1_echo", "OnOff1"],
          ["ManualFieldToggle1_echo", "ManualFieldToggle1"],
          ["HiLow1_echo", "HiLow1"],
          ["LimpHome1_echo", "LimpHome1"],
          ["VeData1_echo", "VeData1"],
          ["NMEA0183Data1_echo", "NMEA0183Data1"],
          ["NMEA2KData1_echo", "NMEA2KData1"]
        ];


        // this is the numerical displays, with scaling done locally
        const source = new EventSource('/events');
        source.addEventListener('open', function () {
          updateInlineStatus(true);
        }, false);
        source.addEventListener('error', function () {
          updateInlineStatus(false);
          // Attempt to reconnect after error
          setTimeout(function () {
            if (source.readyState === EventSource.CLOSED) {
              // You might want to reinitialize the source here if needed
            }
          }, 5000); // Try to reconnect after 5 seconds
        }, false);

        // Initial status - set to connected if we made it this far
        updateInlineStatus(true);

        // ADD THE CODE RIGHT HERE - after the event listeners but before the BulkData listener
        setInterval(function () {
          const timeSinceLastEvent = Date.now() - lastEventTime;
          if (timeSinceLastEvent > 3000) { // 3 seconds without data = disconnected
            updateInlineStatus(false);
          }
        }, 2000); // Check every 2 seconds

        source.addEventListener('CSVData', function (e) {
          // Update timestamp when data is received
          lastEventTime = Date.now();

          // Immediately mark as connected when data arrives
          updateInlineStatus(true);

          // Parse CSV data into an array
          const values = e.data.split(',').map(Number);

          if (values.length !== Object.keys(fieldIndexes).length) {
            console.warn("CSV mismatch: ESP32/HTML field count diverged");
            return;
          }

          const data = {
            AlternatorTemperatureF: values[fieldIndexes.AlternatorTemperatureF], // 0
            DutyCycle: values[fieldIndexes.DutyCycle],
            BatteryV: values[fieldIndexes.BatteryV], //2
            MeasuredAmps: values[fieldIndexes.MeasuredAmps],
            RPM: values[fieldIndexes.RPM],//4
            Channel3V: values[fieldIndexes.Channel3V],
            IBV: values[fieldIndexes.IBV],//6
            Bcur: values[fieldIndexes.Bcur],
            VictronVoltage: values[fieldIndexes.VictronVoltage],//8
            LoopTime: values[fieldIndexes.LoopTime],
            WifiStrength: values[fieldIndexes.WifiStrength],//10
            WifiHeartBeat: values[fieldIndexes.WifiHeartBeat],
            SendWifiTime: values[fieldIndexes.SendWifiTime],//12
            AnalogReadTime: values[fieldIndexes.AnalogReadTime],
            VeTime: values[fieldIndexes.VeTime],//14
            MaximumLoopTime: values[fieldIndexes.MaximumLoopTime],
            HeadingNMEA: values[fieldIndexes.HeadingNMEA],//16
            vvout: values[fieldIndexes.vvout],
            iiout: values[fieldIndexes.iiout],//18
            FreeHeap: values[fieldIndexes.FreeHeap],
            IBVMax: values[fieldIndexes.IBVMax], //20
            MeasuredAmpsMax: values[fieldIndexes.MeasuredAmpsMax],
            RPMMax: values[fieldIndexes.RPMMax], //22
            SoC_percent: values[fieldIndexes.SoC_percent],
            EngineRunTime: values[fieldIndexes.EngineRunTime],
            EngineCycles: values[fieldIndexes.EngineCycles],
            AlternatorOnTime: values[fieldIndexes.AlternatorOnTime],
            AlternatorFuelUsed: values[fieldIndexes.AlternatorFuelUsed],
            ChargedEnergy: values[fieldIndexes.ChargedEnergy],
            DischargedEnergy: values[fieldIndexes.DischargedEnergy],
            AlternatorChargedEnergy: values[fieldIndexes.AlternatorChargedEnergy],
            MaxAlternatorTemperatureF: values[fieldIndexes.MaxAlternatorTemperatureF],
            TemperatureLimitF: values[fieldIndexes.TemperatureLimitF],
            FullChargeVoltage: values[fieldIndexes.FullChargeVoltage],
            TargetAmpz: values[fieldIndexes.TargetAmpz],
            TargetFloatVoltage1: values[fieldIndexes.TargetFloatVoltage1],
            SwitchingFrequency: values[fieldIndexes.SwitchingFrequency],
            interval1: values[fieldIndexes.interval1],
            FieldAdjustmentInterval1: values[fieldIndexes.FieldAdjustmentInterval1],
            ManualVoltage: values[fieldIndexes.ManualVoltage],
            SwitchControlOverride1: values[fieldIndexes.SwitchControlOverride1],
            OnOff1: values[fieldIndexes.OnOff1],
            ManualFieldToggle1: values[fieldIndexes.ManualFieldToggle1],
            HiLow1: values[fieldIndexes.HiLow1],
            LimpHome1: values[fieldIndexes.LimpHome1],
            VeData1: values[fieldIndexes.VeData1],
            NMEA0183Data1: values[fieldIndexes.NMEA0183Data1],
            NMEA2KData1: values[fieldIndexes.NMEA2KData1]
          };

          window._debugData = data;


          const updateFields = (fieldArray) => {
            for (const [elementId, key] of fieldArray) {
              const el = document.getElementById(elementId);
              if (!el) continue;
              const value = data[key];
              if (value === undefined || isNaN(value)) {
                el.textContent = "—";
                continue;
              }
              if (["BatteryV", "Channel3V", "IBV", "VictronVoltage", "vvout", "FullChargeVoltage", "TargetFloatVoltage1", "ManualVoltage"].includes(key)) {
                el.textContent = (value / 100).toFixed(2);
              } else if (["MeasuredAmps", "Bcur", "iiout", "TargetAmpz"].includes(key)) {
                el.textContent = (value / 10).toFixed(1);
              } else {
                el.textContent = Math.round(value);
              }
            }
          };

          updateFields(telemetryFields);  // only visible span updates


          // Update echo elements
          if ('TemperatureLimitF' in data) {
            document.getElementById('TemperatureLimitF_echo').textContent = data.TemperatureLimitF;
          }
          if ('FullChargeVoltage' in data) {
            document.getElementById('FullChargeVoltage_echo').textContent = (data.FullChargeVoltage / 100).toFixed(2);
          }
          if ('TargetAmpz' in data) {
            document.getElementById('TargetAmpz_echo').textContent = data.TargetAmpz;
          }
          if ('TargetFloatVoltage1' in data) {
            document.getElementById('TargetFloatVoltage1_echo').textContent = (data.TargetFloatVoltage1 / 100).toFixed(2);
          }
          if ('SwitchingFrequency' in data) {
            document.getElementById('SwitchingFrequency_echo').textContent = data.SwitchingFrequency;
          }
          if ('interval1' in data) {
            document.getElementById('interval1_echo').textContent = (data.interval1 / 100).toFixed(2);
          }
          if ('FieldAdjustmentInterval1' in data) {
            document.getElementById('FieldAdjustmentInterval1_echo').textContent = (data.FieldAdjustmentInterval1 / 100).toFixed(2);
          }
          if ('ManualVoltage' in data) {
            document.getElementById('ManualVoltage_echo').textContent = (data.ManualVoltage / 100).toFixed(2);
          }
          if ('SwitchControlOverride1' in data) {
            document.getElementById('SwitchControlOverride1_echo').textContent = data.SwitchControlOverride1;
          }
          if ('OnOff1' in data) {
            document.getElementById('OnOff1_echo').textContent = data.OnOff1;
          }
          if ('ManualFieldToggle1' in data) {
            document.getElementById('ManualFieldToggle1_echo').textContent = data.ManualFieldToggle1;
          }
          if ('HiLow1' in data) {
            document.getElementById('HiLow1_echo').textContent = data.HiLow1;
          }
          if ('LimpHome1' in data) {
            document.getElementById('LimpHome1_echo').textContent = data.LimpHome1;
          }
          if ('VeData1' in data) {
            document.getElementById('VeData1_echo').textContent = data.VeData1;
          }
          if ('NMEA0183Data1' in data) {
            document.getElementById('NMEA0183Data1_echo').textContent = data.NMEA0183Data1;
          }
          if ('NMEA2KData1' in data) {
            document.getElementById('NMEA2KData1_echo').textContent = data.NMEA2KData1;
          }

          const now = Math.floor(Date.now() / 1000);

          // Update plot data - this section remains the same
          // Update WiFi Signal plot data
          if ('WifiStrength' in data && typeof uplot !== 'undefined') {
            const strength = parseFloat(data.WifiStrength);
            wifiData[0].push(now);
            wifiData[1].push(strength);
            if (wifiData[0].length > maxPoints) {
              wifiData[0].shift();
              wifiData[1].shift();
            }
          }

          // Update Current & Temperature plot data arrays
          if (typeof currentTempPlot !== 'undefined') {
            const battCurrent = 'Bcur' in data ? parseFloat(data.Bcur) / 10 : null;
            const altCurrent = 'MeasuredAmps' in data ? parseFloat(data.MeasuredAmps) / 10 : null;
            const fieldCurrent = 'iiout' in data ? parseFloat(data.iiout) / 10 : null;
            const altTemp = 'AlternatorTemperatureF' in data ? parseFloat(data.AlternatorTemperatureF) : null;

            currentTempData[0].push(now);
            currentTempData[1].push(battCurrent);
            currentTempData[2].push(altCurrent);
            currentTempData[3].push(fieldCurrent);
            currentTempData[4].push(altTemp);

            if (currentTempData[0].length > maxPoints) {
              currentTempData[0].shift();
              currentTempData[1].shift();
              currentTempData[2].shift();
              currentTempData[3].shift();
              currentTempData[4].shift();
            }
          }

          // Update Voltage plot data arrays
          if (typeof voltagePlot !== 'undefined') {
            const adsBattV = 'BatteryV' in data ? parseFloat(data.BatteryV) / 100 : null;
            const victronBattV = 'VictronVoltage' in data ? parseFloat(data.VictronVoltage) / 100 : null;
            const inaBattV = 'IBV' in data ? parseFloat(data.IBV) / 100 : null;

            voltageData[0].push(now);
            voltageData[1].push(adsBattV);
            voltageData[2].push(victronBattV);
            voltageData[3].push(inaBattV);

            if (voltageData[0].length > maxPoints) {
              voltageData[0].shift();
              voltageData[1].shift();
              voltageData[2].shift();
              voltageData[3].shift();
            }
          }

          // Update RPM plot data arrays
          if (typeof rpmPlot !== 'undefined') {
            const rpmValue = 'RPM' in data ? parseFloat(data.RPM) : null;

            rpmData[0].push(now);
            rpmData[1].push(rpmValue);

            if (rpmData[0].length > maxPoints) {
              rpmData[0].shift();
              rpmData[1].shift();
            }
          }
          // Measure client-side performance
          const clientUpdateTime = Date.now() - lastClientUpdateTime;
          if (lastClientUpdateTime > 0) {  // Skip the first measurement
            clientUpdateData[0].push(now);
            clientUpdateData[1].push(clientUpdateTime);

            if (clientUpdateData[0].length > maxPoints) {
              clientUpdateData[0].shift();
              clientUpdateData[1].shift();
            }
          }
          lastClientUpdateTime = Date.now();


          // Only update the plots if enough time has passed - now update all three plots
          const nowMs = Date.now();
          if (nowMs - lastPlotUpdate > PLOT_UPDATE_INTERVAL_MS) {
            schedulePlotUpdate();
            scheduleCurrentTempPlotUpdate();
            scheduleVoltagePlotUpdate();
            scheduleRPMPlotUpdate();
            scheduleClientUpdatePlotUpdate();

            // Add connection status check here - it will run once per second with your other updates
            const timeSinceLastEvent = nowMs - lastEventTime;
            if (timeSinceLastEvent > 5000) { // 5 seconds without new data = disconnected
              updateInlineStatus(false);
            } else {
              updateInlineStatus(true);
            }

            lastPlotUpdate = nowMs;
          }
        }, false);
      }

      // Initialize toggle states on page load
      document.getElementById("ManualFieldToggle1_checkbox").checked = (document.getElementById("ManualFieldToggle1").value === "1");
      document.getElementById("SwitchControlOverride1_checkbox").checked = (document.getElementById("SwitchControlOverride1").value === "1");
      document.getElementById("OnOff1_checkbox").checked = (document.getElementById("OnOff1").value === "1");
      document.getElementById("LimpHome1_checkbox").checked = (document.getElementById("LimpHome1").value === "1");
      document.getElementById("HiLow1_checkbox").checked = (document.getElementById("HiLow1").value === "1");
      document.getElementById("VeData1_checkbox").checked = (document.getElementById("VeData1").value === "1");
      document.getElementById("NMEA0183Data1_checkbox").checked = (document.getElementById("NMEA0183Data1").value === "1");
      document.getElementById("NMEA2KData1_checkbox").checked = (document.getElementById("NMEA2KData1").value === "1");

      document.getElementById("admin_password").addEventListener("change", updatePasswordFields);
    });
  </script>

  <div id="corner-status" class="corner-status corner-status-connected">CONNECTED</div>

<!-- Hidden fallback elements to satisfy JavaScript field lookups DELETE THIS HACK JOB -->
<div style="display:none;">
  <span id="RPMMaxID" style="display:none;">0</span>
  <span id="SoC_percentID" style="display:none;">0</span>
  <span id="EngineRunTimeID" style="display:none;">0</span>
  <span id="EngineCyclesID" style="display:none;">0</span>
  <span id="AlternatorOnTimeID" style="display:none;">0</span>
  <span id="AlternatorFuelUsedID" style="display:none;">0</span>
  <span id="ChargedEnergyID" style="display:none;">0</span>
  <span id="DischargedEnergyID" style="display:none;">0</span>
  <span id="AlternatorChargedEnergyID" style="display:none;">0</span>
  <span id="MaxAlternatorTemperatureF_ID" style="display:none;">0</span>
  <span id="TemperatureLimitF_echo" style="display:none;">0</span>
  <span id="FullChargeVoltage_echo" style="display:none;">0</span>
  <span id="TargetAmpz_echo" style="display:none;">0</span>
  <span id="TargetFloatVoltage1_echo" style="display:none;">0</span>
  <span id="SwitchingFrequency_echo" style="display:none;">0</span>
  <span id="interval1_echo" style="display:none;">0</span>
  <span id="FieldAdjustmentInterval1_echo" style="display:none;">0</span>
  <span id="ManualVoltage_echo" style="display:none;">0</span>
  <span id="SwitchControlOverride1_echo" style="display:none;">0</span>
  <span id="OnOff1_echo" style="display:none;">0</span>
  <span id="ManualFieldToggle1_echo" style="display:none;">0</span>
  <span id="HiLow1_echo" style="display:none;">0</span>
  <span id="LimpHome1_echo" style="display:none;">0</span>
  <span id="VeData1_echo" style="display:none;">0</span>
  <span id="NMEA0183Data1_echo" style="display:none;">0</span>
  <span id="NMEA2KData1_echo" style="display:none;">0</span>
  <input id="TemperatureLimitF" style="display:none;" value="0" />
  <input id="FullChargeVoltage" style="display:none;" value="0" />
  <input id="TargetAmpz" style="display:none;" value="0" />
  <input id="TargetFloatVoltage1" style="display:none;" value="0" />
  <input id="SwitchingFrequency" style="display:none;" value="0" />
  <input id="interval1" style="display:none;" value="0" />
  <input id="FieldAdjustmentInterval1" style="display:none;" value="0" />
  <input id="ManualVoltage" style="display:none;" value="0" />
  <input id="SwitchControlOverride1" style="display:none;" value="0" />
  <input id="OnOff1" style="display:none;" value="0" />
  <input id="ManualFieldToggle1" style="display:none;" value="0" />
  <input id="HiLow1" style="display:none;" value="0" />
  <input id="LimpHome1" style="display:none;" value="0" />
  <input id="VeData1" style="display:none;" value="0" />
  <input id="NMEA0183Data1" style="display:none;" value="0" />
  <input id="NMEA2KData1" style="display:none;" value="0" />
  </div>
  

  



</body>

</html>
