<!DOCTYPE HTML> 
<html>
  <head>
    <title>Alternator Controller Interface</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script>
      function submitMessage() {
        setTimeout(function(){ document.location.reload(false); }, 500);   
      }
    </script>
  </head>
  <body>
    <h2>Settings</h2>
    <style>
      table, th, td {
        border: 1px solid black;
        border-radius: 10px;
      }
    </style>
    <table>
      <tr>
        <td>
          <form action="/get" target="hidden-form">
            Alternator Temperature Limit (F) (%TemperatureLimitF%): <input type="text" name="TemperatureLimitF">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Bulk Voltage Target (%FullChargeVoltage%): <input type="number " name="FullChargeVoltage">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Target Amps (A) (%TargetAmpz%): <input type="number " name="TargetAmpz">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Controller Field Switching Frequency (hz) (%SwitchingFrequency%): <input type="number " name="SwitchingFrequency">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Float Voltage Target (V) (%TargetFloatVoltage1%): <input type="number " name="TargetFloatVoltage1">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Field Adjustment Step Size (V) (%interval1%): <input type="number " name="interval1">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Field Adjustment Interval (ms)) (%FieldAdjustmentInterval1%): <input type="number " name="FieldAdjustmentInterval1">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
        </td>
        <td>
          <form action="/get" target="hidden-form">
            Manual Field Control Toggle (%ManualFieldToggle1%): <input type="number " name="ManualFieldToggle1">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Manual Voltage Setpoint (V) (%ManualVoltage%): <input type="number " name="ManualVoltage">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Physical Switch Panel Override (%SwitchControlOverride1%): <input type="number " name="SwitchControlOverride1">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            On/Off (%OnOff1%): <input type="number " name="OnOff1">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Low(0)/High(1) Mode (%HiLow1%): <input type="number " name="HiLow1">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
          <hr>
          <form action="/get" target="hidden-form">
            Limp Home Mode (%LimpHome1%): <input type="number " name="LimpHome1">
            <input type="submit" value="Submit" onclick="submitMessage()">
          </form>
        </td>
      </tr>
    </table>
    <iframe style="display:none" name="hidden-form"></iframe>
    <hr/>
    <h2>Sensor and Output Data </h2>
    <table>
      <tr>
        <td>
          <div class="card">
            <p> ADS Battery Voltage</p>
            <p><span class="reading"><span id="BatteryVID">%BATTERYV%</span> V</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> Victron Battery Voltage</p>
            <p><span class="reading"><span id="VictronVoltageID">%VVOLT%</span> V</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> INA Battery Voltage</p>
            <p><span class="reading"><span id="IBVID">%IBVV%</span> V</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> ADS Ch3 Voltage</p>
            <p><span class="reading"><span id="ADS3ID">%ADSCH3VLTS%</span> V</span></p>
          </div>
        </td>
        <td>
          <div class="card">
            <p> ADS Alternator Current</p><p><span class="reading"><span id="MeasAmpsID">%MEASA%</span> A</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> Alternator Temperature</p><p><span class="reading"><span id="AltTempID">%ALTERNATORTEMPERATUREF%</span> &deg;F</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> INA Battery Current</p><p><span class="reading"><span id="BCurrID">%BCURR%</span> A</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> Engine Speed</p><p><span class="reading"><span id="RPMID">%RPMM%</span> rev/min</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> GPS Heading</p><p><span class="reading"><span id="GPSHID">%GPSH%</span> &deg</span></p>
          </div>
        </td>
        <td>
          <div class="card">
            <p> Loop Time</p>
            <p><span class="reading"><span id="LoopTimeID">%LOOPTIME%</span> uS;</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> Maximum Loop Time</p>
            <p><span class="reading"><span id="MaximumLoopTimeID">%MAXIMUMLOOPTIME%</span> uS;</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> Controller Field Duty Cycle</p>
            <p><span class="reading"><span id="DutyCycleID">%DUTYCYCLE%</span> &percnt;</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> Controller Field Voltage</p>
            <p><span class="reading"><span id="FieldVoltsID">%FIELDVOLTS%</span> V</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> Controller Field Current</p>
            <p><span class="reading"><span id="FieldAmpsID">%FIELDAMPS%</span> A</span></p>
          </div>
        </td>
        <td>
          <div class="card">
            <p> Wifi Strength</p>
            <p><span class="reading"><span id="WifiStrengthID">%WIFISTRENGTH%</span> dB;</span></p>
          </div>
          <hr/>
          <div class="card">
            <p> Wifi Heartbeat</p>
            <p><span class="reading"><span id="WifiHeartBeatID">%WIFIHEARTBEAT%</span> #;</span></p>
          </div>
        </td>
      </tr>
    </table>
    <script>
      if (!!window.EventSource) {
        var source = new EventSource('/events');
        source.addEventListener('BulkData', function(e) {
          const data = JSON.parse(e.data);
          const fields = {
            AltTempID: "AlternatorTemperatureF",
            LoopTimeID: "LoopTime",
            MaximumLoopTimeID: "MaximumLoopTime",
            DutyCycleID: "DutyCycle",
            BatteryVID: "BatteryV",
            MeasAmpsID: "MeasuredAmps",
            RPMID: "RPM",
            ADS3ID: "Channel3V",
            IBVID: "IBV",
            BCurrID: "Bcur",
            VictronVoltageID: "VictronVoltage",
            FieldVoltsID: "vvout",
            FieldAmpsID: "iiout",
            GPSHID: "HeadingNMEA",
            WifiStrengthID: "WifiStrength",
            WifiHeartBeatID: "WifiHeartBeat",
            AnalogReadTimeID: "AnalogReadTime",
            SendWifiTimeID: "SendWifiTime",
            VeTimeID: "VeTime"
          };
          for (const [elementId, key] of Object.entries(fields)) {
            const el = document.getElementById(elementId);
            if (el && key in data) {
              el.innerHTML = data[key];
            }
          }
        }, false);
      }
    </script>
  </body>
</html>
