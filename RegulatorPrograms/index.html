<!-- X Engineering Alternator Regulator
    Copyright (C) 2025  Mark Nickerson

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

 See <https://www.gnu.org/licenses/> for GNU General Public License

Contact me at mark@xengineering.net       -->


<!DOCTYPE HTML>

<html>

<head>
  <meta charset="utf-8" />
  <title>X Engineering Alternator Regulator</title>
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <link href="/uPlot.min.css" rel="stylesheet" />
  <script src="/uPlot.iife.min.js">
  </script>
  <style>
    :root {
      --primary: #333333;
      /* Dark gray primary */
      --accent: #00a19a;
      /* Orange accent */
      --bg-light: #f5f5f5;
      /* Very light gray background */
      --text-dark: #333333;
      /* Dark text */
      --text-light: #ffffff;
      /* Light text */
      --card-light: #ffffff;
      /* White card background */
      --border: #dddddd;
      /* Light border */
      --reading: #333333;
      /* Reading text color (changed from green) */
      --radius: 4px;
      /* Border radius */
    }

    body {
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      padding: 0.5rem;
      background-color: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.4;
      font-size: 14px;
    }

    h2 {
      color: var(--text-dark);
      border-bottom: 2px solid var(--accent);
      padding-bottom: 0.25rem;
      margin-top: 1rem;
      margin-bottom: 0.75rem;
      font-size: 18px;
    }

    /* For fixing plot legend appearance */
    .u-legend .u-value {
      display: none !important;
    }


    input[type="submit"] {
      background-color: #555555;
      color: white;
      border: none;
      padding: 4px 10px;
      cursor: pointer;
      border-radius: var(--radius);
      font-weight: bold;
      width: 60px;
    }

    input[type="submit"]:hover {
      background-color: var(--accent);
    }

    input[type="text"],
    input[type="number"],
    input[type="password"] {
      background: #ffffff;
      color: var(--text-dark);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 4px;
      width: 80px;
    }

    input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px;
    }

    .card {
      background: var(--card-light);
      padding: 10px;
      border-left: 2px solid var(--accent);
      border-radius: var(--radius);
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      margin-bottom: 4px;
    }

    .card p {
      margin: 0.25rem 0;
    }

    .card p:first-child {
      font-weight: bold;
      color: var(--text-dark);
      border-bottom: 1px solid var(--border);
      padding-bottom: 0.25rem;
      margin-bottom: 0.25rem;
      font-size: 13px;
    }

    .reading {
      font-size: 1.1rem;
      font-weight: bold;
    }

    .reading span {
      color: var(--reading);
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 10px;
    }


    .settings-card {
      background: var(--card-light);
      border-radius: var(--radius);
      padding: 10px;
      margin-bottom: 16px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }


    .section-title {
      background-color: #f0f0f0;
      color: var(--text-dark);
      padding: 6px 10px;
      margin: 0 0 10px 0;
      border-radius: var(--radius);
      font-weight: bold;
      border-left: 2px solid var(--accent);
      font-size: 14px;
    }

    hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 8px 0;
    }


    .confirm-msg {
      transition: opacity 1s ease;
      opacity: 1;
    }

    .confirm-msg.fade-out {
      opacity: 0;
    }


    .form-row {
      display: flex;
      justify-content: flex-start;
      /* Change from space-between to flex-start */
      align-items: center;
      margin-bottom: 8px;
    }

    .form-label {
      flex: 1;
      text-align: left;
      padding-right: 10px;
    }

    .form-input {
      display: flex;
      justify-content: flex-end;
      align-items: center;
    }

    /* Security section forms only - prevent passwords from being too far away */
    .settings-card:first-child form {
      display: flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
    }

    /* Fix for Security section layout only */
    #security-card .form-label {
      flex: 0 0 auto;
      min-width: 6em;
    }


    /* Locking Settings Capability */
    .locked input,
    .locked select,
    .locked button {
      pointer-events: none;
      opacity: 0.5;
    }

    .locked label.switch {
      pointer-events: none;
      opacity: 0.6;
    }


    /* Responsive adjustments */
    @media (max-width: 992px) {
      .settings-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }

      body {
        font-size: 13px;
      }

      .grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      }
    }

    /* Toggle switch styling */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 20px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 20px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 14px;
      width: 14px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked+.slider {
      background-color: #00a19a;
    }

    input:checked+.slider:before {
      transform: translateX(20px);
    }

    .toggle-label {
      font-size: 0.9em;
      margin: 0 8px;
      vertical-align: middle;
    }

    .toggle-label {
      font-size: 0.9em;
      margin: 0 8px;
      vertical-align: middle;
    }



    .corner-status {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      border-radius: 10px;
      color: white;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
      z-index: 999;
      opacity: 0.9;
    }

    .corner-status-connected {
      background-color: #00a19a;
    }

    .corner-status-disconnected {
      background-color: #F44336;
    }

    /* Reset Buttons */
    .btn-small {
      background-color: #e0e0e0;
      color: #000;
      border: none;
      padding: 2px 8px;
      font-size: 0.8em;
      margin-left: 10px;
      border-radius: 4px;
      cursor: pointer;
      vertical-align: middle;
    }

    .btn-small:hover {
      background-color: #cccccc;
    }


    /* Dark Mode */
    .dark-mode {
      --primary: gray;
      --accent: #00a19a;
      --bg-light: #121212;
      --text-dark: gray;
      --text-light: gray;
      --card-light: #1e1e1e;
      --border: #444444;
      --reading: gray;
    }

    .dark-mode input[type="text"],
    .dark-mode input[type="number"],
    .dark-mode input[type="password"] {
      background-color: #1e1e1e;
      color: #cccccc;
      border-color: #444444;
    }

    .dark-mode .section-title {
      background-color: #222222;
      color: #cccccc;
    }

    .dark-mode input[type="submit"] {
      background-color: #2a2a2a;
      color: #aaaaaa;
    }

    .dark-mode input[type="submit"]:hover {
      background-color: #444444;
    }

    .slider {
      background-color: #dddddd;
      /* light gray */
      box-shadow: inset 0 0 1px rgba(0, 0, 0, 0.3);
    }

    .slider:before {
      background-color: #fefefe;
      /* near-white */
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
    }

    .dark-mode .slider {
      background-color: #333333;
    }

    .dark-mode .slider:before {
      background-color: gray;
      border: 1px solid #444444;
    }

    .dark-mode input[type="checkbox"] {
      filter: brightness(0.6);
      background-color: #444444;
      border: 1px solid #666666;
    }
  </style>

  <script> // Connection monitoring variables
    let lastEventTime = Date.now();
    const connectionCheckInterval = 10000; // Check every 10 seconds

    // to prevent double toggling
    let toggleStates = {}; // Track current toggle states
    let userInitiatedToggles = new Set(); // Track user-initiated changes


    function submitMessage() {
      // console.log("Form submitted - values will update shortly");    // shut this off because it's "Console log spam" that might cause delay?
      // setTimeout(function () { document.location.reload(false); }, 500); // not needed anymore because
    }

    let rpmAmpsInitialized = false; // this is for the RPM/AMP speed based charging table

    // for faster wifi reconnects after scheduled shut downs:
    let reconnectInterval;
    let reconnectionAttempts = 0;
    const maxReconnectionAttempts = 15; // Try for 30 seconds (15 attempts × 2 seconds)

  </script>
</head>

<body><iframe name="hidden-form" style="display:none"></iframe>
  <h2>Security</h2>
  <div class="settings-grid">
    <div class="settings-card" id="security-card">
      <div id="lock-status" style="font-weight:bold; color:#00a19a; margin-bottom:10px;">LOCKED</div>

      <!-- Enter Password Row -->
      <div class="form-row">
        <div class="form-label">Enter Password:</div>
        <div class="form-input">
          <form action="/get" method="GET" target="hidden-form" onsubmit="setAdminPassword(); return false;">
            <input type="hidden" name="dummy" value="1" />
            <div style="display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 8px;">
              <input type="password" id="admin_password" name="admin_password" autocomplete="current-password" />
              <input type="submit" id="admin_password_set" value="Enter" style="width: 70px;" />
              <label style="font-size: 12px; white-space: nowrap;">
                <input type="checkbox" onclick="togglePassword('admin_password')">Show
              </label>
              <span id="admin_password_msg" style="grid-column: 1 / -1; font-size: 12px; color: #00a19a;"></span>
            </div>
          </form>
        </div>
      </div>

      <!-- New Password Row -->
      <div class="form-row">
        <div class="form-label">New Password:</div>
        <div class="form-input">
          <form action="/setPassword" method="POST" target="hidden-form" onsubmit="return setNewPassword();">
            <input type="hidden" name="password" class="password_field" />
            <div style="display: grid; grid-template-columns: 1fr auto auto; align-items: center; gap: 8px;">
              <input type="password" id="newpassword" name="newpassword" />
              <input type="submit" id="newpassword_set" value="Set" style="width: 70px;" />
              <label style="font-size: 12px; white-space: nowrap;">
                <input type="checkbox" onclick="togglePassword('newpassword')">Show
              </label>
              <span id="newpassword_msg" style="grid-column: 1 / -1; font-size: 12px; color: #00a19a;"></span>
            </div>
          </form>
        </div>
      </div>

      <!-- Lock Button -->
      <div style="text-align: left; margin-top: 10px;">
        <input type="submit" id="lock-settings-button" onclick="lockSettingsManually(); return false;"
        value="Lock Settings" style="width: 120px;" />
      </div>


    </div>
  </div>


  <style>
#lock-settings-button {
  background-color: #555555 !important;
}
#lock-settings-button:hover {
  background-color: var(--accent) !important;
}
  </style>

  <script>
    function togglePassword(id) {
      var field = document.getElementById(id);
      field.type = (field.type === "password") ? "text" : "password";
    }


    //Reset buttons
    function resetTemp() {
      updatePasswordFields();
      document.getElementById("ResetTemp").value = "1";
      document.getElementById("ResetTemp_button").form.submit();
      document.getElementById("MaxAlternatorTemperatureF_ID").textContent = "--";
    }
    function resetCurrent() {
      updatePasswordFields();
      document.getElementById("ResetCurrent").value = "1";
      document.getElementById("ResetCurrent_button").form.submit();
      document.getElementById("MeasuredAmpsMaxID").textContent = "—";
    }
    function resetVoltage() {
      updatePasswordFields();
      document.getElementById("ResetVoltage").value = "1";
      document.getElementById("ResetVoltage_button").form.submit();
      document.getElementById("IBVMaxID").textContent = "--";
    }
    function resetEngineRunTime() {
      updatePasswordFields();
      document.getElementById("ResetEngineRunTime").value = "1";
      document.getElementById("ResetEngineRunTime_button").form.submit();
      document.getElementById("EngineRunTimeID").textContent = "--";
    }
    function resetAlternatorOnTime() {
      updatePasswordFields();
      document.getElementById("ResetAlternatorOnTime").value = "1";
      document.getElementById("ResetAlternatorOnTime_button").form.submit();
      document.getElementById("AlternatorOnTimeID").textContent = "--";
    }
    function resetEnergy() {
      updatePasswordFields();
      document.getElementById("ResetEnergy").value = "1";
      document.getElementById("ResetEnergy_button").form.submit();
      document.getElementById("ChargedEnergyID").textContent = "--";
    }
    function resetDischargedEnergy() {
      updatePasswordFields();
      document.getElementById("ResetDischargedEnergy").value = "1";
      document.getElementById("ResetDischargedEnergy_button").form.submit();
      document.getElementById("DischargedEnergyID").textContent = "--";
    }
    function resetFuelUsed() {
      updatePasswordFields();
      document.getElementById("ResetFuelUsed").value = "1";
      document.getElementById("ResetFuelUsed_button").form.submit();
      document.getElementById("AlternatorFuelUsedID").textContent = "--";
    }
    function resetAlternatorChargedEnergy() {
      updatePasswordFields();
      document.getElementById("ResetAlternatorChargedEnergy").value = "1";
      document.getElementById("ResetAlternatorChargedEnergy_button").form.submit();
      document.getElementById("AlternatorChargedEnergyID").textContent = "--";
    }
    function resetEngineCycles() {
      updatePasswordFields();
      document.getElementById("ResetEngineCycles").value = "1";
      document.getElementById("ResetEngineCycles_button").form.submit();
      document.getElementById("EngineCyclesID").textContent = "--";
    }
    function resetRPMMax() {
      updatePasswordFields();
      document.getElementById("ResetRPMMax").value = "1";
      document.getElementById("ResetRPMMax_button").form.submit();
      document.getElementById("RPMMaxID").textContent = "--";
    }
    function resetThermTemp() {
      updatePasswordFields();
      document.getElementById("ResetThermTemp").value = "1";
      document.getElementById("ResetThermTemp_button").form.submit();
      document.getElementById("MaxTemperatureThermistorID").textContent = "--";
    }
  </script>


  <h2>Settings</h2>

  <div id="settings-section" class="locked">
    <div class="settings-grid">

      <div class="settings-card">
        <div class="section-title">Basic</div>
        <hr />
        <div class="form-row">
          <div class="form-label">Alternator Enable (<span id="OnOff_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="OnOff_checkbox" type="checkbox" onchange="if(handleUserToggle('OnOff_checkbox', 'OnOff', 'OnOff')) { this.form.submit();
              submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="OnOff" name="OnOff" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>


        <hr />
        <div class="form-row">
          <div class="form-label">Charge Rate Normal (A) (<span id="TargetAmps_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="TargetAmps" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Charge Rate Low (A) (<span id="TargetAmpL_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="TargetAmpL" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Charge Rate (<span id="HiLow_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Low</span>
              <label class="switch">
                <input id="HiLow_checkbox" type="checkbox" onchange="if(handleUserToggle('HiLow_checkbox', 'HiLow', 'HiLow')) { this.form.submit();
              submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">Normal</span>
              <input id="HiLow" name="HiLow" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Amp Target Source (<span id="AmpSrc_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <select name="AmpSrc">
                <option value="0">Alt Hall Effect Sensor</option>
                <option value="1">Battery Shunt</option>
                <option value="2">NMEA2K Batt</option>
                <option value="3">NMEA2K Alt</option>
                <option value="4">NMEA0183 Batt</option>
                <option value="5">NMEA0183 Alt</option>
                <option value="6">Victron Batt</option>
                <option value="7">Other</option>
              </select>
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>


        <hr />
        <div class="form-row">
          <div class="form-label">Alternator Temp Limit (F) (<span id="TemperatureLimitF_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="TemperatureLimitF" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Bulk Voltage (<span id="FullChargeVoltage_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="FullChargeVoltage" type="number" step="0.01" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Float Voltage (<span id="TargetFloatVoltage_echo">0</span>):
          </div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="TargetFloatVoltage" type="number" step="0.01" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

      </div> <!-- CLOSE Basic settings-card ??? -->

      <div class="settings-card">
        <div class="section-title">Thermistor</div>

        <div class="form-row">
          <div class="form-label">Temp Source (<span id="TempSource_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Digital</span>
              <label class="switch">
                <input id="TempSource_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('TempSource_checkbox', 'TempSource', 'TempSource')) { this.form.submit(); submitMessage(); }">
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">Thermistor</span>
              <input id="TempSource" name="TempSource" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Series Resistor R_fixed Ω (<span id="R_fixed_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="R_fixed" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Thermistor Beta (<span id="Beta_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="Beta" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Reference Temp T0 °C (<span id="T0_C_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="T0_C" type="number" step="0.1" min="-50" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>



      </div> <!-- CLOSE Thermistor settings-card -->




      <div class="settings-card">
        <div class="section-title">Advanced</div>
        <div class="form-row">
          <div class="form-label">Field Switching Freq (hz) (<span id="SwitchingFrequency_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="SwitchingFrequency" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Field Adj Step (V) (<span id="interval_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="interval" type="number" step="0.001" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Field Adj. Time Interval (ms) (<span id="FieldAdjustmentinterval_echo">0</span>):
          </div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="FieldAdjustmentinterval" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />

        <hr />
        <div class="form-row">
          <div class="form-label">RPM Scaling Factor (<span id="RPMScalingFactor_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="RPMScalingFactor" type="number" step="0.01" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />

        <div class="form-row">
          <div class="form-label">Ignore Alt Temp (<span id="IgnoreTemperature_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">No</span>
              <label class="switch">
                <input id="IgnoreTemperature_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('IgnoreTemperature_checkbox', 'IgnoreTemperature', 'IgnoreTemperature')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">Yes</span>
              <input id="IgnoreTemperature" name="IgnoreTemperature" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Defer to BMS Control (<span id="BMSLogic_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">No</span>
              <label class="switch">
                <input id="BMSLogic_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('BMSLogic_checkbox', 'BMSLogic', 'BMSLogic')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">Yes</span>
              <input id="BMSLogic" name="BMSLogic" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>


        <hr />
        <div class="form-row">
          <div class="form-label">Charge on ___ BMS Signal (<span id="BMSLogicLevelOff_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Low</span>
              <label class="switch">
                <input id="BMSLogicLevelOff_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('BMSLogicLevelOff_checkbox', 'BMSLogicLevelOff', 'BMSLogicLevelOff')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">High</span>
              <input id="BMSLogicLevelOff" name="BMSLogicLevelOff" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Min Field (%) (<span id="MinDuty_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="MinDuty" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Max Field (%) (<span id="MaxDuty_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="MaxDuty" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Field Resistance (Ohms) (<span id="FieldResistance_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="FieldResistance" type="number" step=".01" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">RPM-Based Charging Curve (<span id="AmpControlByRPM_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="AmpControlByRPM_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('AmpControlByRPM_checkbox', 'AmpControlByRPM', 'AmpControlByRPM')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="AmpControlByRPM" name="AmpControlByRPM" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
        <div class="form-row">
          <div class="form-label"></div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <table style="border-collapse: collapse; width: 100%;">
                <thead>
                  <tr>
                    <th
                      style="padding: 4px 8px; border-bottom: 1px solid var(--border); text-align: left; font-size: 12px;">
                      RPM</th>
                    <th
                      style="padding: 4px 8px; border-bottom: 1px solid var(--border); text-align: left; font-size: 12px;">
                      Amps</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="padding: 2px;"><input name="RPM1" type="number" step="1" min="0" id="RPM1_input"
                        style="width: 70px;" /></td>
                    <td style="padding: 2px;"><input name="Amps1" type="number" step="1" min="0" id="Amps1_input"
                        style="width: 70px;" /></td>
                  </tr>
                  <tr>
                    <td style="padding: 2px;"><input name="RPM2" type="number" step="1" min="0" id="RPM2_input"
                        style="width: 70px;" /></td>
                    <td style="padding: 2px;"><input name="Amps2" type="number" step="1" min="0" id="Amps2_input"
                        style="width: 70px;" /></td>
                  </tr>
                  <tr>
                    <td style="padding: 2px;"><input name="RPM3" type="number" step="1" min="0" id="RPM3_input"
                        style="width: 70px;" /></td>
                    <td style="padding: 2px;"><input name="Amps3" type="number" step="1" min="0" id="Amps3_input"
                        style="width: 70px;" /></td>
                  </tr>
                  <tr>
                    <td style="padding: 2px;"><input name="RPM4" type="number" step="1" min="0" id="RPM4_input"
                        style="width: 70px;" /></td>
                    <td style="padding: 2px;"><input name="Amps4" type="number" step="1" min="0" id="Amps4_input"
                        style="width: 70px;" /></td>
                  </tr>
                  <tr>
                    <td style="padding: 2px;"><input name="RPM5" type="number" step="1" min="0" id="RPM5_input"
                        style="width: 70px;" /></td>
                    <td style="padding: 2px;"><input name="Amps5" type="number" step="1" min="0" id="Amps5_input"
                        style="width: 70px;" /></td>
                  </tr>
                  <tr>
                    <td style="padding: 2px;"><input name="RPM6" type="number" step="1" min="0" id="RPM6_input"
                        style="width: 70px;" /></td>
                    <td style="padding: 2px;"><input name="Amps6" type="number" step="1" min="0" id="Amps6_input"
                        style="width: 70px;" /></td>
                  </tr>
                  <tr>
                    <td style="padding: 2px;"><input name="RPM7" type="number" step="1" min="0" id="RPM7_input"
                        style="width: 70px;" /></td>
                    <td style="padding: 2px;"><input name="Amps7" type="number" step="1" min="0" id="Amps7_input"
                        style="width: 70px;" /></td>
                  </tr>
                </tbody>
              </table>
              <div style="margin-top: 8px;">
                <input onclick="submitMessage()" type="submit" value="Save" />
              </div>
            </form>
          </div>
        </div>



      </div> <!-- closes .settings-card for Advanced -->


      <div class="settings-card">
        <div class="section-title">Alarm / Emergency</div>
        <div class="form-row">
          <div class="form-label">Alarm Enable (<span id="AlarmActivate_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="AlarmActivate_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('AlarmActivate_checkbox', 'AlarmActivate', 'AlarmActivate')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">Armed</span>
              <input id="AlarmActivate" name="AlarmActivate" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">High Temp Alarm (F) (<span id="TempAlarm_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="TempAlarm" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">High Voltage Alarm (<span id="VoltageAlarmHigh_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="VoltageAlarmHigh" type="number" step="0.1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Low Voltage Alarm (<span id="VoltageAlarmLow_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="VoltageAlarmLow" type="number" step="0.1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">High Current Alarm (Alt) (A) (<span id="CurrentAlarmHigh_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="CurrentAlarmHigh" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">High Current Alarm (Batt) (A) (<span id="MaximumAllowedBatteryAmps_echo">0</span>):
          </div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="MaximumAllowedBatteryAmps" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Manual Field Enable (<span id="ManualFieldToggle_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="ManualFieldToggle_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('ManualFieldToggle_checkbox', 'ManualFieldToggle', 'ManualFieldToggle')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="ManualFieldToggle" name="ManualFieldToggle" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Manual Field PWM (%) (<span id="ManualDuty_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="ManualDuty" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Limp Home Mode (<span id="LimpHome_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="LimpHome_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('LimpHome_checkbox', 'LimpHome', 'LimpHome')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="LimpHome" name="LimpHome" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>

      </div>


      <div class="settings-card">
        <div class="section-title">Battery Monitor</div>

        <hr />
        <div class="form-row">
          <div class="form-label">Battery Capacity (Amp hr) (<span id="BatteryCapacity_Ah_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="BatteryCapacity_Ah" type="number" step="1" min="0" max="3000" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>


        <div class="form-row">
          <div class="form-label">Current Threshold (A) (<span id="CurrentThreshold_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="CurrentThreshold" type="number" step="0.1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Tail Current (%) (<span id="TailCurrent_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="TailCurrent" type="number" step="0.1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Charge Detection Time (s) (<span id="ChargedDetectionTime_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="ChargedDetectionTime" type="number" step="1" min="0" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>


        <hr />
        <div class="form-row">
          <div class="form-label">Peukert Exponent (<span id="PeukertExponent_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="PeukertExponent" type="number" step="0.01" min="1" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Charge Efficiency (%) (<span id="ChargeEfficiency_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="ChargeEfficiency" type="number" step="1" min="50" max="100" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Max Charge Detect Voltage (<span id="ChargedVoltage_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="ChargedVoltage" type="number" step="0.01" min="12" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Shunt Resitance uOhms (micro)(<span id="ShuntResistanceMicroOhm_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="ShuntResistanceMicroOhm" type="number" step="1" min="12" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Set SoC Manually (%) (<span id="ManualSOCPoint_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="ManualSOCPoint" type="number" step="1" min="0" max="100" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
      </div>
      <div class="settings-card">
        <div class="section-title">System</div>
        <hr />
        <div class="form-row">
          <div class="form-label">Dark Mode:</div>
          <div class="form-input">
            <span class="toggle-label">Off</span>
            <label class="switch">
              <input id="DarkMode_checkbox" type="checkbox"
                onchange="document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', this.checked ? '1' : '0'); updateUplotTheme(currentTempPlot); updateUplotTheme(voltagePlot); updateUplotTheme(rpmPlot);" />
              <span class="slider round"></span>
            </label>
            <span class="toggle-label">On</span>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">VE.Direct Data (<span id="VeData_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="VeData_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('VeData_checkbox', 'VeData', 'VeData')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="VeData" name="VeData" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">NMEA 0183 Data (<span id="NMEA0183Data_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="NMEA0183Data_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('NMEA0183Data_checkbox', 'NMEA0183Data', 'NMEA0183Data')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="NMEA0183Data" name="NMEA0183Data" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">NMEA2K Data (<span id="NMEA2KData_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="NMEA2KData_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('NMEA2KData_checkbox', 'NMEA2KData', 'NMEA2KData')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="NMEA2KData" name="NMEA2KData" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Battery Voltage Source (<span id="BatteryVoltageSource_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <select name="BatteryVoltageSource">
                <option value="0">0 INA228</option>
                <option value="1">1 ADS1115</option>
                <option value="2">2 VictronVeDirect</option>
                <option value="3">3 NMEA0183</option>
                <option value="4">4 NMEA2K</option>
              </select>
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Invert Battery Amps (<span id="InvertBattAmps_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">No</span>
              <label class="switch">
                <input id="InvertBattAmps_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('InvertBattAmps_checkbox', 'InvertBattAmps', 'InvertBattAmps')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">Yes</span>
              <input id="InvertBattAmps" name="InvertBattAmps" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Invert Alternator Amps (<span id="InvertAltAmps_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">No</span>
              <label class="switch">
                <input id="InvertAltAmps_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('InvertAltAmps_checkbox', 'InvertAltAmps', 'InvertAltAmps')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">Yes</span>
              <input id="InvertAltAmps" name="InvertAltAmps" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Alternator Current Offset (A) (<span id="AlternatorCOffset_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="AlternatorCOffset" type="number" step=".01" min="-100" max="100" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Battery Current Offset (A) (<span id="BatteryCOffset_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="BatteryCOffset" type="number" step=".01" min="-100" max="100" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>
        <hr />
        <div class="form-row">
          <div class="form-label">Plot Points (X axis length) (<span id="maxPoints_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <input name="maxPoints" type="number" step="1" min="5" max="10000" />
              <input onclick="submitMessage()" type="submit" value="Set" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Switch Panel Override (<span id="SwitchControlOverride_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="SwitchControlOverride_checkbox" type="checkbox" onchange="if(handleUserToggle('SwitchControlOverride_checkbox', 'SwitchControlOverride',
              'SwitchControlOverride')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="SwitchControlOverride" name="SwitchControlOverride" type="number" value=""
                style="display:none;" />
            </form>
          </div>
        </div>

        <hr />
        <div class="form-row">
          <div class="form-label">Ignition Override (<span id="IgnitionOverride_echo">0</span>):</div>
          <div class="form-input">
            <form action="/get" method="GET" target="hidden-form">
              <input type="hidden" name="password" class="password_field">
              <span class="toggle-label">Off</span>
              <label class="switch">
                <input id="IgnitionOverride_checkbox" type="checkbox"
                  onchange="if(handleUserToggle('IgnitionOverride_checkbox', 'IgnitionOverride', 'IgnitionOverride')) { this.form.submit(); submitMessage(); }" />
                <span class="slider round"></span>
              </label>
              <span class="toggle-label">On</span>
              <input id="IgnitionOverride" name="IgnitionOverride" type="number" value="" style="display:none;" />
            </form>
          </div>
        </div>


        <hr />
        <div class="form-row">
          <div class="form-label">Factory Reset:</div>
          <div class="form-input">
            <button type="button" id="factory-reset-btn" onclick="factoryReset()"
              style="background-color: #555555; color: white; border: none; padding: 8px 16px; border-radius: var(--radius); cursor: pointer; font-weight: bold;">
              Restore Defaults
            </button>
          </div>
        </div>

      </div>
    </div>
  </div>

  <h2>Live Data</h2>
  <div class="settings-grid">

    <div class="settings-card">
      <div class="section-title">Battery</div>
      <div class="grid">
        <div class="card">
          <p>ADS Battery Voltage</p>
          <p class="reading"><span id="BatteryVID">0</span> V</p>
        </div>
        <div class="card">
          <p>Victron Battery Voltage</p>
          <p class="reading"><span id="VictronVoltageID">0</span> V</p>
        </div>
        <div class="card">
          <p>INA Battery Voltage</p>
          <p class="reading"><span id="IBVID">0</span> V</p>
        </div>

        <div class="card">
          <p>Max Ever Battery Voltage</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="IBVMaxID">0</span><span>V</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetVoltage" id="ResetVoltage" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetVoltage()" id="ResetVoltage_button">Reset</button>
            </form>
          </div>
        </div>

        <div class="card">
          <p>State of Charge</p>
          <p class="reading"><span id="SoC_percentID">0</span> %</p>
        </div>

        <div class="card">
          <p>Alternator Output Energy</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="AlternatorChargedEnergyID">0</span><span>Wh</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetAlternatorChargedEnergy" id="ResetAlternatorChargedEnergy" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetAlternatorChargedEnergy()"
                id="ResetAlternatorChargedEnergy_button">Reset</button>
            </form>
          </div>
        </div>

        <div class="card">
          <p>Batt Discharged Energy</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="DischargedEnergyID">0</span><span>Wh</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetDischargedEnergy" id="ResetDischargedEnergy" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetDischargedEnergy()"
                id="ResetDischargedEnergy_button">Reset</button>
            </form>
          </div>
        </div>

        <div class="card">
          <p>Battery Current</p>
          <p class="reading"><span id="BCurrID">0</span> A</p>
        </div>

        <div class="card">
          <p>Victron Battery Current</p>
          <p class="reading"><span id="VictronCurrentID">0</span> A</p>
        </div>


      </div>
    </div>

    <div class="settings-card">
      <div class="section-title">Alternator</div>
      <div class="grid">
        <div class="card">
          <p>Alternator Current</p>
          <p class="reading"><span id="MeasAmpsID">0</span> A</p>
        </div>
        <div class="card">
          <p>Alternator Temp</p>
          <p class="reading"><span id="AltTempID">0</span> °F</p>
        </div>
        <div class="card">
          <p>Command Field Duty Cycle</p>
          <p class="reading"><span id="DutyCycleID">0</span> %</p>
        </div>
        <div class="card">
          <p>Field Volts (Calc'd)</p>
          <p class="reading"><span id="FieldVoltsID">0</span> V</p>
        </div>
        <div class="card">
          <p>Field Amps (Calc'd)) </p>
          <p class="reading"><span id="FieldAmpsID">0</span> A</p>
        </div>
        <div class="card">
          <p>Alternator On Time</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="AlternatorOnTimeID">0</span><span>H:M:S</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetAlternatorOnTime" id="ResetAlternatorOnTime" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetAlternatorOnTime()"
                id="ResetAlternatorOnTime_button">Reset</button>
            </form>
          </div>
        </div>

        <div class="card">
          <p>Fuel Used by Alt</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="AlternatorFuelUsedID">0</span><span>L</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetFuelUsed" id="ResetFuelUsed" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetFuelUsed()" id="ResetFuelUsed_button">Reset</button>
            </form>
          </div>
        </div>

        <div class="card">
          <p>Batt Charged Energy</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="ChargedEnergyID">0</span><span>Wh</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetEnergy" id="ResetEnergy" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetEnergy()" id="ResetEnergy_button">Reset</button>
            </form>
          </div>
        </div>

        <div class="card">
          <p>Max Alt Output Current</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="MeasuredAmpsMaxID">0</span><span>A</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetCurrent" id="ResetCurrent" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetCurrent()" id="ResetCurrent_button">Reset</button>
            </form>
          </div>
        </div>


        <div class="card">
          <p>Max Alternator Temp</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="MaxAlternatorTemperatureF_ID">0</span><span>°F</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetTemp" id="ResetTemp" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetTemp()" id="ResetTemp_button">Reset</button>
            </form>
          </div>
        </div>

        <div class="card">
          <p>Thermistor Temperature</p>
          <p class="reading"><span id="temperatureThermistorID">0</span> °C</p>
        </div>

        <div class="card">
          <p>Max Thermistor Temp</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="MaxTemperatureThermistorID">0</span><span>°C</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetThermTemp" id="ResetThermTemp" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetThermTemp()"
                id="ResetThermTemp_button">Reset</button>
            </form>
          </div>
        </div>


      </div>
    </div>

    <div class="settings-card">
      <div class="section-title">Engine</div>
      <div class="grid">
        <div class="card">
          <p>Engine Speed</p>
          <p class="reading"><span id="RPMID">0</span> rev/min</p>
        </div>
        <div class="card">
          <p>Engine Run Time</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="EngineRunTimeID">0</span><span>H:M:S</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetEngineRunTime" id="ResetEngineRunTime" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetEngineRunTime()"
                id="ResetEngineRunTime_button">Reset</button>
            </form>
          </div>
        </div>

        <div class="card">
          <p>Engine Rev Counter</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="EngineCyclesID">0</span><span>rotations</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetEngineCycles" id="ResetEngineCycles" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetEngineCycles()"
                id="ResetEngineCycles_button">Reset</button>
            </form>
          </div>
        </div>

        <div class="card">
          <p>Max Engine RPM</p>
          <div class="reading" style="display: flex; align-items: center; gap: 4px;">
            <span id="RPMMaxID">0</span><span>rev/min</span>
            <form action="/get" method="GET" target="hidden-form" style="display: inline;">
              <input type="hidden" name="ResetRPMMax" id="ResetRPMMax" value="0" />
              <input type="hidden" name="password" class="password_field" />
              <button type="button" class="btn-small" onclick="resetRPMMax()" id="ResetRPMMax_button">Reset</button>
            </form>
          </div>
        </div>
      </div>
    </div> <!-- ADD THIS: Closes Engine settings-card -->


    <div class="settings-card">
      <div class="section-title">ESP32</div>
      <div class="grid">
        <div class="card">
          <p>Loop Time</p>
          <p class="reading"><span id="LoopTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>Maximum Loop Time</p>
          <p class="reading"><span id="MaximumLoopTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>Analog Read Time (Max)</p>
          <p class="reading"><span id="AnalogReadTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>Wifi Send Time</p>
          <p class="reading"><span id="SendWifiTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>VE Dir. Read Time</p>
          <p class="reading"><span id="VeTimeID">0</span> μs</p>
        </div>
        <div class="card">
          <p>Wifi Strength</p>
          <p class="reading"><span id="WifiStrengthID">0</span> dB</p>
        </div>
        <div class="card">
          <p>Wifi Heartbeat</p>
          <p class="reading"><span id="WifiHeartBeatID">0</span> #</p>
        </div>
        <div class="card">
          <p>Free Heap Memory</p>
          <p class="reading"><span id="FreeHeapID">0</span> kb</p>
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="section-title">Other</div>
      <div class="grid">
        <div class="card">
          <p>GPS Heading</p>
          <p class="reading"><span id="GPSHID">0</span> °</p>
        </div>
        <div class="card">
          <p>ADS Ch3 Voltage</p>
          <p class="reading"><span id="ADS3ID">0</span> V</p>
        </div>
      </div> <!-- Closes .grid -->
    </div> <!-- Closes settings-card (Other) -->
  </div> <!-- CLOSE settings-grid for Live Data -->



  <h2>Plots</h2>

  <div class="settings-card">
    <div class="plot-container" id="current-temp-plot"></div>
  </div>
  <div class="settings-card">
    <div class="plot-container" id="voltage-plot"></div>
  </div>


  <div class="settings-card">
    <div class="plot-container" id="rpm-plot"></div>
  </div>


  <!-- Console -->
  <div class="settings-card">
    <div class="form-label">
      Console
      <button onclick="clearConsole()" style="font-size: 12px; margin-left: 10px;">Clear</button>
    </div>
    <div id="consoleOutput"
      style="font-family: monospace; font-size: 13px; background: #111; color: #0f0; padding: 6px; height: 160px; overflow-y: auto; border: 1px solid var(--border); white-space: pre-wrap;">
    </div>
  </div>


  <script>

    function debounce(fn, delay) {
      let timer = null;
      return function (...args) {
        clearTimeout(timer);
        timer = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    let currentAdminPassword = "";

    function updatePasswordFields() {
      const password = currentAdminPassword || document.getElementById("admin_password").value;
      const passwordFields = document.querySelectorAll('.password_field');
      passwordFields.forEach(field => {
        field.value = password;
      });
    }



    const fieldIndexes = {
      AlternatorTemperatureF: 0,
      DutyCycle: 1,
      BatteryV: 2,
      MeasuredAmps: 3,
      RPM: 4,
      Channel3V: 5,
      IBV: 6,
      Bcur: 7,
      VictronVoltage: 8,
      LoopTime: 9,
      WifiStrength: 10,
      WifiHeartBeat: 11,
      SendWifiTime: 12,
      AnalogReadTime: 13,
      VeTime: 14,
      MaximumLoopTime: 15,
      HeadingNMEA: 16,
      vvout: 17,
      iiout: 18,
      FreeHeap: 19,
      IBVMax: 20,
      MeasuredAmpsMax: 21,
      RPMMax: 22,
      SoC_percent: 23,
      EngineRunTime: 24,
      EngineCycles: 25,
      AlternatorOnTime: 26,
      AlternatorFuelUsed: 27,
      ChargedEnergy: 28,
      DischargedEnergy: 29,
      AlternatorChargedEnergy: 30,
      MaxAlternatorTemperatureF: 31,
      TemperatureLimitF: 32,
      FullChargeVoltage: 33,
      TargetAmps: 34,
      TargetFloatVoltage: 35,
      SwitchingFrequency: 36,
      interval: 37,
      FieldAdjustmentinterval: 38,
      ManualDuty: 39,
      SwitchControlOverride: 40,
      OnOff: 41,
      ManualFieldToggle: 42,
      HiLow: 43,
      LimpHome: 44,
      VeData: 45,
      NMEA0183Data: 46,
      NMEA2KData: 47,
      TargetAmpL: 48,
      CurrentThreshold: 49,
      PeukertExponent: 50,
      ChargeEfficiency: 51,
      ChargedVoltage: 52,
      TailCurrent: 53,
      ChargedDetectionTime: 54,
      IgnoreTemperature: 55,
      BMSLogic: 56,
      BMSLogicLevelOff: 57,
      AlarmActivate: 58,
      TempAlarm: 59,
      VoltageAlarmHigh: 60,
      VoltageAlarmLow: 61,
      CurrentAlarmHigh: 62,
      FourWay: 63,
      RPMScalingFactor: 64,
      ResetTemp: 65,
      ResetVoltage: 66,
      ResetCurrent: 67,
      ResetEngineRunTime: 68,
      ResetAlternatorOnTime: 69,
      ResetEnergy: 70,
      MaximumAllowedBatteryAmps: 71,
      ManualSOCPoint: 72,
      BatteryVoltageSource: 73,
      AmpControlByRPM: 74,
      RPM1: 75,
      RPM2: 76,
      RPM3: 77,
      RPM4: 78,
      Amps1: 79,
      Amps2: 80,
      Amps3: 81,
      Amps4: 82,
      RPM5: 83,
      RPM6: 84,
      RPM7: 85,
      Amps5: 86,
      Amps6: 87,
      Amps7: 88,
      ShuntResistanceMicroOhm: 89,
      InvertAltAmps: 90,
      InvertBattAmps: 91,
      MaxDuty: 92,
      MinDuty: 93,
      FieldResistance: 94,
      maxPoints: 95,
      AlternatorCOffset: 96,
      BatteryCOffset: 97,
      BatteryCapacity_Ah: 98,
      AmpSrc: 99,
      R_fixed: 100,
      Beta: 101,
      T0_C: 102,
      TempSource: 103,
      IgnitionOverride: 104,
      temperatureThermistor: 105,
      MaxTemperatureThermistor: 106,
      VictronCurrent: 107

    };

    //Factory Reset Logic
    function factoryReset() {
      if (!currentAdminPassword) {
        alert("You must be logged in to perform a factory reset.");
        return;
      }

      const confirmation = confirm(
        "⚠️ FACTORY RESET WARNING ⚠️\n\n" +
        "This will restore settings to hardcoded defaults.\n" +
        "All your custom configurations will be lost.\n\n" +
        "Are you sure you want to continue?"
      );
      if (!confirmation) return;

      const button = document.getElementById('factory-reset-btn');
      button.disabled = true;
      button.textContent = 'Resetting...';
      button.style.backgroundColor = '#6c757d';

      const formData = new FormData();
      formData.append("password", currentAdminPassword);

      fetch("/factoryReset", {
        method: "POST",
        body: formData
      })
        .then(response => response.text())
        .then(text => {
          if (text.trim() === "OK") {
            alert("✅ Factory reset complete!\n\nPage will reload in 500ms to show default values.");
            setTimeout(() => {
              window.location.reload();
            }, 500);
          } else {
            alert("❌ Factory reset failed: " + text);
            button.disabled = false;
            button.textContent = 'Restore Defaults';
            button.style.backgroundColor = '#555555';
          }
        })
        .catch(err => {
          alert("❌ Error during factory reset: " + err.message);
          button.disabled = false;
          button.textContent = 'Restore Defaults';
          button.style.backgroundColor = '#555555';
        });
    }


    function updateInlineStatus(isConnected) {
      const cornerStatus = document.getElementById('corner-status');

      if (cornerStatus) {
        if (isConnected) {
          cornerStatus.className = 'corner-status corner-status-connected';
          cornerStatus.textContent = 'WIFI CONNECTED';
        } else {
          cornerStatus.className = 'corner-status corner-status-disconnected';
          cornerStatus.textContent = 'WIFI DISCONNECTED';
        }
      }
    }


    // Current and Temperature Plot Data
    // [timestamps, battery current, alternator current, field current, alt temp]
    const currentTempData = [[], [], [], [], []];
    let currentTempPlot;

    // Voltage Plot Data
    // [timestamps, ADS Battery V, Victron Battery V, INA Battery V]
    const voltageData = [[], [], [], []];
    let voltagePlot;

    // RPM Plot Data
    const rpmData = [[], []];
    let rpmPlot;

    let lastPlotUpdate = 0; // Timestamp of last time we updated the plot
    const PLOT_UPDATE_INTERVAL_MS = 1000; // Only update every 2 seconds (adjust as needed)

    //Console
    function clearConsole() {
      document.getElementById("consoleOutput").innerHTML = "";
    }

    function scheduleCurrentTempPlotUpdate() {
      if (!window.currentTempUpdateScheduled && currentTempPlot) {
        window.currentTempUpdateScheduled = true;
        requestAnimationFrame(() => {
          currentTempPlot.setData(currentTempData);
          window.currentTempUpdateScheduled = false;
        });
      }
    }

    function scheduleVoltagePlotUpdate() {
      if (!window.voltageUpdateScheduled && voltagePlot) {
        window.voltageUpdateScheduled = true;
        requestAnimationFrame(() => {
          voltagePlot.setData(voltageData);
          window.voltageUpdateScheduled = false;
        });
      }
    }

    function scheduleRPMPlotUpdate() {
      if (!window.rpmUpdateScheduled && rpmPlot) {
        window.rpmUpdateScheduled = true;
        requestAnimationFrame(() => {
          rpmPlot.setData(rpmData);
          window.rpmUpdateScheduled = false;
        });
      }
    }



    function initCurrentTempPlot() {
      const plotEl = document.getElementById('current-temp-plot');
      if (!plotEl) {
        console.error("Current & Temperature plot element not found");
        return;
      }

      const opts = {
        width: Math.min(plotEl.clientWidth, 800),
        height: 300,
        title: "Current & Temperature History",
        series: [
          { label: null, points: { show: false }, stroke: "transparent", width: 0 }, // timestamp - hidden
          {
            label: "Battery Current (A)",
            stroke: "#4CAF50",
            width: 2,
            scale: "current"
          },
          {
            label: "Alternator Current (A)",
            stroke: "#2196F3",
            width: 2,
            scale: "current"
          },
          {
            label: "Field Current (A)",
            stroke: "#9C27B0",
            width: 2,
            scale: "current"
          },
          {
            label: "Alt. Temp (°F)",
            stroke: "#FF5722",
            width: 2,
            scale: "current"
          }
        ],
        axes: [
          {},
          {
            scale: "current",
            label: "Amperes / °F",
            grid: { show: true },
            side: 3
          }
        ],
        scales: {
          x: { time: true },
          current: { auto: true }
        },
        // DISABLE the built-in legend completely
        legend: {
          show: false
        },
        plugins: [{
          hooks: {
            init: [
              (u) => {
                // Create custom legend after plot is created
                createCustomLegend('current-temp-plot', [
                  { label: "Battery Current (A)", color: "#4CAF50" },
                  { label: "Alternator Current (A)", color: "#2196F3" },
                  { label: "Field Current (A)", color: "#9C27B0" },
                  { label: "Alt. Temp (°F)", color: "#FF5722" }
                ]);

                const resizePlot = debounce(() => {
                  const plotEl = document.getElementById("current-temp-plot");
                  if (plotEl && currentTempPlot) {
                    currentTempPlot.setSize({ width: plotEl.clientWidth, height: 300 });
                  }
                }, 1000);
                new ResizeObserver(resizePlot).observe(plotEl);
              }
            ]
          }
        }]
      };

      currentTempPlot = new uPlot(opts, currentTempData, plotEl);
      const startTime = Math.floor(Date.now() / 1000);
      currentTempData[0].push(startTime);
      currentTempData[1].push(0);
      currentTempData[2].push(0);
      currentTempData[3].push(0);
      currentTempData[4].push(100);
      currentTempPlot.setData(currentTempData);
    }

    function initVoltagePlot() {
      const plotEl = document.getElementById('voltage-plot');
      if (!plotEl) {
        console.error("Voltage plot element not found");
        return;
      }

      const opts = {
        width: Math.min(plotEl.clientWidth, 800),
        height: 300,
        title: "Battery Voltage History",
        series: [
          { label: null, points: { show: false }, stroke: "transparent", width: 0 }, // timestamp - hidden
          {
            label: "ADS Battery (V)",
            stroke: "#FF9800",
            width: 2,
            scale: "voltage"
          },
          {
            label: "Victron Battery (V)",
            stroke: "#3F51B5",
            width: 2,
            scale: "voltage"
          },
          {
            label: "INA Battery (V)",
            stroke: "#607D8B",
            width: 2,
            scale: "voltage"
          }
        ],
        axes: [
          {},
          {
            scale: "voltage",
            label: "Volts",
            grid: { show: true }
          }
        ],
        scales: {
          x: { time: true },
          voltage: { auto: true }
        },
        // DISABLE the built-in legend completely
        legend: {
          show: false
        },
        plugins: [{
          hooks: {
            init: [
              (u) => {
                // Create custom legend after plot is created
                createCustomLegend('voltage-plot', [
                  { label: "ADS Battery (V)", color: "#FF9800" },
                  { label: "Victron Battery (V)", color: "#3F51B5" },
                  { label: "INA Battery (V)", color: "#607D8B" }
                ]);

                const resizePlot = debounce(() => {
                  const plotEl = document.getElementById("voltage-plot");
                  if (plotEl && voltagePlot) {
                    voltagePlot.setSize({ width: plotEl.clientWidth, height: 300 });
                  }
                }, 1000);
                new ResizeObserver(resizePlot).observe(plotEl);
              }
            ]
          }
        }]
      };

      voltagePlot = new uPlot(opts, voltageData, plotEl);
      const startTime = Math.floor(Date.now() / 1000);
      voltageData[0].push(startTime);
      voltageData[1].push(0);
      voltageData[2].push(0);
      voltageData[3].push(0);
      voltagePlot.setData(voltageData);
    }

    function initRPMPlot() {
      const plotEl = document.getElementById('rpm-plot');
      if (!plotEl) {
        console.error("RPM plot element not found");
        return;
      }

      const opts = {
        width: Math.min(plotEl.clientWidth, 800),
        height: 300,
        title: "RPM History",
        series: [
          { label: null, points: { show: false }, stroke: "transparent", width: 0 }, // timestamp - hidden
          {
            label: "RPM",
            stroke: "#E91E63",
            width: 2,
            scale: "rpm"
          }
        ],
        axes: [
          {},
          {
            scale: "rpm",
            label: "rev/min",
            grid: { show: true }
          }
        ],
        scales: {
          x: { time: true },
          rpm: { auto: true }
        },
        // DISABLE the built-in legend completely
        legend: {
          show: false
        },
        plugins: [{
          hooks: {
            init: [
              (u) => {
                // Create custom legend after plot is created
                createCustomLegend('rpm-plot', [
                  { label: "RPM", color: "#E91E63" }
                ]);

                const resizePlot = debounce(() => {
                  const plotEl = document.getElementById("rpm-plot");
                  if (plotEl && rpmPlot) {
                    rpmPlot.setSize({ width: plotEl.clientWidth, height: 300 });
                  }
                }, 1000);
                new ResizeObserver(resizePlot).observe(plotEl);
              }
            ]
          }
        }]
      };

      rpmPlot = new uPlot(opts, rpmData, plotEl);
      const startTime = Math.floor(Date.now() / 1000);
      rpmData[0].push(startTime);
      rpmData[1].push(0);
      rpmPlot.setData(rpmData);
    }

    // Custom legend creation function
    function createCustomLegend(plotId, legendItems) {
      const plotContainer = document.getElementById(plotId);
      if (!plotContainer) return;

      // Remove any existing custom legend
      const existingLegend = plotContainer.querySelector('.custom-legend');
      if (existingLegend) {
        existingLegend.remove();
      }

      // Create new custom legend
      const legendDiv = document.createElement('div');
      legendDiv.className = 'custom-legend';
      legendDiv.style.cssText = `
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 10px;
    flex-wrap: wrap;
  `;

      legendItems.forEach(item => {
        const legendItem = document.createElement('div');
        legendItem.style.cssText = `
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
    `;

        const colorBox = document.createElement('div');
        colorBox.style.cssText = `
      width: 16px;
      height: 3px;
      background-color: ${item.color};
      border-radius: 1px;
    `;

        const label = document.createElement('span');
        label.textContent = item.label;
        label.style.color = 'var(--text-dark)';

        legendItem.appendChild(colorBox);
        legendItem.appendChild(label);
        legendDiv.appendChild(legendItem);
      });

      plotContainer.appendChild(legendDiv);
    }



    function setAdminPassword() {
      const button = document.getElementById('admin_password_set');
      const input = document.getElementById('admin_password');
      const msg = document.getElementById('admin_password_msg');
      const password = input.value;

      if (!password) {
        msg.textContent = "Missing Password";
        msg.style.color = "#00a19a";
        setTimeout(() => { msg.textContent = ""; }, 2000);
        return false;
      }

      button.disabled = true;

      const formData = new FormData();
      formData.append("password", password);

      fetch("/checkPassword", {
        method: "POST",
        body: formData
      })
        .then(response => response.text())
        .then(text => {
          if (text.trim() === "OK") {


            currentAdminPassword = password;
            // Unlock settings
            const section = document.getElementById('settings-section');
            if (section) section.classList.remove("locked");


            const lockStatus = document.getElementById('lock-status');
            if (lockStatus) {
              lockStatus.textContent = "Settings are Unlocked";
              lockStatus.style.color = "#00a19a";
            }

            updatePasswordFields();
            msg.textContent = "Password Accepted";
            msg.style.color = "#00a19a";
          }

          else {
            msg.textContent = "Wrong Password";
            msg.style.color = "#00a19a";
          }
          input.value = "";
          setTimeout(() => { msg.textContent = ""; button.disabled = false; }, 2000);
        })
        .catch(err => {
          msg.textContent = "Error";
          msg.style.color = "#00a19a";
          setTimeout(() => { msg.textContent = ""; button.disabled = false; }, 2000);
        });

      return false;
    }

    function lockSettingsManually() {
      const section = document.getElementById('settings-section');
      if (section) section.classList.add("locked");

      const lockStatus = document.getElementById('lock-status');
      if (lockStatus) {
        lockStatus.textContent = "Settings are Locked --- Enter Password to Unlock";
        lockStatus.style.color = "#00a19a";
      }
      currentAdminPassword = "";
    }





    function setNewPassword() {
      const button = document.getElementById('newpassword_set');
      const input = document.getElementById('newpassword');
      const msg = document.getElementById('newpassword_msg');
      const currentPassword = currentAdminPassword;

      if (!currentPassword || !input.value) {
        msg.textContent = "Missing fields";
        msg.style.color = "#00a19a";
        setTimeout(() => { msg.textContent = ""; }, 2000);
        return false;
      }

      button.disabled = true;

      const formData = new FormData();
      formData.append("password", currentPassword);
      formData.append("newpassword", input.value);

      fetch("/setPassword", {
        method: "POST",
        body: formData
      })
        .then(response => response.text())
        .then(text => {
          if (text.trim() === "OK") {
            msg.textContent = "Password Changed";
            msg.style.color = "#00a19a";
          } else {
            msg.textContent = "Wrong Password";
            msg.style.color = "#00a19a";
          }
          input.value = "";
          setTimeout(() => { msg.textContent = ""; button.disabled = false; }, 2000);
        })
        .catch(err => {
          msg.textContent = "Error";
          msg.style.color = "#00a19a";
          setTimeout(() => { msg.textContent = ""; button.disabled = false; }, 2000);
        });

      return false; // prevent form submit
    }


    //prevent double toggling here
    function updateTogglesFromData(data) {
      try {
        if (!data) return;

        const updateCheckbox = (id, value, dataKey) => {
          if (value === undefined) return;

          const checkbox = document.getElementById(id);
          if (!checkbox) return;

          const shouldBeChecked = (value === 1);

          // Skip update if this was a user-initiated change
          if (userInitiatedToggles.has(dataKey)) {
            userInitiatedToggles.delete(dataKey);
            return;
          }

          // Only update if state actually changed
          if (checkbox.checked !== shouldBeChecked) {
            checkbox.checked = shouldBeChecked;
            toggleStates[dataKey] = value;
          }
        };

        // Update all toggle checkboxes with their data keys
        updateCheckbox("ManualFieldToggle_checkbox", data.ManualFieldToggle, "ManualFieldToggle");
        updateCheckbox("SwitchControlOverride_checkbox", data.SwitchControlOverride, "SwitchControlOverride");
        updateCheckbox("OnOff_checkbox", data.OnOff, "OnOff");
        updateCheckbox("LimpHome_checkbox", data.LimpHome, "LimpHome");
        updateCheckbox("HiLow_checkbox", data.HiLow, "HiLow");
        updateCheckbox("VeData_checkbox", data.VeData, "VeData");
        updateCheckbox("NMEA0183Data_checkbox", data.NMEA0183Data, "NMEA0183Data");
        updateCheckbox("NMEA2KData_checkbox", data.NMEA2KData, "NMEA2KData");
        updateCheckbox("IgnoreTemperature_checkbox", data.IgnoreTemperature, "IgnoreTemperature");
        updateCheckbox("BMSLogic_checkbox", data.BMSLogic, "BMSLogic");
        updateCheckbox("BMSLogicLevelOff_checkbox", data.BMSLogicLevelOff, "BMSLogicLevelOff");
        updateCheckbox("AlarmActivate_checkbox", data.AlarmActivate, "AlarmActivate");
        updateCheckbox("AmpControlByRPM_checkbox", data.AmpControlByRPM, "AmpControlByRPM");
        updateCheckbox("InvertAltAmps_checkbox", data.InvertAltAmps, "InvertAltAmps");
        updateCheckbox("InvertBattAmps_checkbox", data.InvertBattAmps, "InvertBattAmps");
        updateCheckbox("IgnitionOverride_checkbox", data.IgnitionOverride, "IgnitionOverride");
        updateCheckbox("TempSource_checkbox", data.TempSource, "TempSource");


      } catch (e) {
        console.log("Error updating toggle states: " + e.message);
      }
    }

    //function to handle user toggle changes without double toggle
    function handleUserToggle(checkboxId, hiddenInputId, dataKey) {
      const checkbox = document.getElementById(checkboxId);
      const hiddenInput = document.getElementById(hiddenInputId);

      if (checkbox && hiddenInput) {
        const newValue = checkbox.checked ? '1' : '0';
        hiddenInput.value = newValue;

        // Mark this as user-initiated to prevent server override
        userInitiatedToggles.add(dataKey);

        // Store the new state
        toggleStates[dataKey] = parseInt(newValue);

        // Clear the flag after a reasonable delay (longer than your server response time)
        setTimeout(() => {
          userInitiatedToggles.delete(dataKey);
        }, 3000);

        return true; // Allow form submission
      }
      return false;
    }

    window.addEventListener("load", function () {
      //gray out Settings on a reload
      const settingsSection = document.getElementById('settings-section');
      if (settingsSection) {
        settingsSection.classList.add("locked");
      }
      const lockStatus = document.getElementById('lock-status');
      if (lockStatus) {
        lockStatus.textContent = "Settings are Locked";
        lockStatus.style.color = "#00a19a";  //  My house orange
      }
      if (localStorage.getItem('darkMode') === '1') {
        document.body.classList.add('dark-mode');
        const darkToggle = document.getElementById("DarkMode_checkbox");
        if (darkToggle) darkToggle.checked = true;
      }

      initCurrentTempPlot();
      initVoltagePlot();
      initRPMPlot();

      if (!!window.EventSource) {
        const telemetryFields = [      //Telemetry: Live sensor data that changes frequently
          ["AltTempID", "AlternatorTemperatureF"],         // 0
          ["DutyCycleID", "DutyCycle"],                    // 1
          ["BatteryVID", "BatteryV"],                      // 2
          ["MeasAmpsID", "MeasuredAmps"],                  // 3
          ["RPMID", "RPM"],                                // 4
          ["ADS3ID", "Channel3V"],                         // 5
          ["IBVID", "IBV"],                                // 6
          ["BCurrID", "Bcur"],                             // 7
          ["VictronVoltageID", "VictronVoltage"],          // 8
          ["LoopTimeID", "LoopTime"],                      // 9
          ["WifiStrengthID", "WifiStrength"],              // 10
          ["WifiHeartBeatID", "WifiHeartBeat"],            // 11
          ["SendWifiTimeID", "SendWifiTime"],              // 12
          ["AnalogReadTimeID", "AnalogReadTime"],          // 13
          ["VeTimeID", "VeTime"],                          // 14
          ["MaximumLoopTimeID", "MaximumLoopTime"],        // 15
          ["GPSHID", "HeadingNMEA"],                       // 16
          ["FieldVoltsID", "vvout"],                       // 17
          ["FieldAmpsID", "iiout"],                        // 18
          ["FreeHeapID", "FreeHeap"],                      // 19
          ["IBVMaxID", "IBVMax"],                          // 20
          ["MeasuredAmpsMaxID", "MeasuredAmpsMax"],        // 21
          ["RPMMaxID", "RPMMax"],                          // 22
          ["SoC_percentID", "SoC_percent"],                // 23
          ["EngineRunTimeID", "EngineRunTime"],            // 24
          ["EngineCyclesID", "EngineCycles"],              // 25
          ["AlternatorOnTimeID", "AlternatorOnTime"],      // 26
          ["AlternatorFuelUsedID", "AlternatorFuelUsed"],  // 27
          ["ChargedEnergyID", "ChargedEnergy"],            // 28
          ["DischargedEnergyID", "DischargedEnergy"],      // 29
          ["AlternatorChargedEnergyID", "AlternatorChargedEnergy"], // 30
          ["MaxAlternatorTemperatureF_ID", "MaxAlternatorTemperatureF"], // 31
          ["temperatureThermistorID", "temperatureThermistor"], //32
          ["MaxTemperatureThermistorID", "MaxTemperatureThermistor"], //33
          ["VictronCurrentID", "VictronCurrent"]          // 34


        ];

        // this is the numerical displays, with scaling done locally
        const source = new EventSource('/events');

        //Console
        source.addEventListener("console", function (event) {
          const timestamp = new Date().toLocaleTimeString();
          const consoleDiv = document.getElementById("consoleOutput");
          const line = document.createElement("div");
          line.textContent = `[${timestamp}] ${event.data}`;
          consoleDiv.appendChild(line);
          consoleDiv.scrollTop = consoleDiv.scrollHeight;
          while (consoleDiv.children.length > 100) {
            consoleDiv.removeChild(consoleDiv.firstChild);
          }
        });


        source.addEventListener('open', function () {
          console.log('EventSource connected successfully');
          updateInlineStatus(true);

          // Reset reconnection state on successful connection
          if (reconnectInterval) {
            clearInterval(reconnectInterval);
            reconnectInterval = null;
          }
          reconnectionAttempts = 0;
        }, false);


        source.addEventListener('error', function () {
          console.log('EventSource error - starting aggressive reconnection');
          updateInlineStatus(false);

          if (!reconnectInterval && reconnectionAttempts < maxReconnectionAttempts) {
            reconnectInterval = setInterval(() => {
              reconnectionAttempts++;
              console.log(`Reconnection attempt ${reconnectionAttempts}/${maxReconnectionAttempts}`);

              if (reconnectionAttempts >= maxReconnectionAttempts) {
                clearInterval(reconnectInterval);
                reconnectInterval = null;
                console.log('Max reconnection attempts reached');
                return;
              }

              window.location.reload(); // Force page reload to establish new connection
            }, 2000); // Try every 2 seconds
          }
        }, false);

        // Initial status - set to connected if we made it this far
        updateInlineStatus(true);

        setInterval(function () {
          const timeSinceLastEvent = Date.now() - lastEventTime;
          if (timeSinceLastEvent > 3000) { // 3 seconds without data = disconnected
            updateInlineStatus(false);
          }
        }, 2000); // Check every 2 seconds

        source.addEventListener('CSVData', function (e) {
          // Update timestamp when data is received
          lastEventTime = Date.now();

          // Immediately mark as connected when data arrives
          updateInlineStatus(true);

          // Parse CSV data into an array
          const values = e.data.split(',').map(Number);

          if (values.length !== Object.keys(fieldIndexes).length) {
            console.warn("CSV mismatch: ESP32/HTML field count diverged");
            return;
          }
          const data = {
            AlternatorTemperatureF: values[fieldIndexes.AlternatorTemperatureF], // 0
            DutyCycle: values[fieldIndexes.DutyCycle],
            BatteryV: values[fieldIndexes.BatteryV], // 2
            MeasuredAmps: values[fieldIndexes.MeasuredAmps],
            RPM: values[fieldIndexes.RPM], // 4
            Channel3V: values[fieldIndexes.Channel3V],
            IBV: values[fieldIndexes.IBV], // 6
            Bcur: values[fieldIndexes.Bcur],
            VictronVoltage: values[fieldIndexes.VictronVoltage], // 8
            LoopTime: values[fieldIndexes.LoopTime],
            WifiStrength: values[fieldIndexes.WifiStrength], // 10
            WifiHeartBeat: values[fieldIndexes.WifiHeartBeat],
            SendWifiTime: values[fieldIndexes.SendWifiTime], // 12
            AnalogReadTime: values[fieldIndexes.AnalogReadTime],
            VeTime: values[fieldIndexes.VeTime], // 14
            MaximumLoopTime: values[fieldIndexes.MaximumLoopTime],
            HeadingNMEA: values[fieldIndexes.HeadingNMEA], // 16
            vvout: values[fieldIndexes.vvout],
            iiout: values[fieldIndexes.iiout], // 18
            FreeHeap: values[fieldIndexes.FreeHeap],
            IBVMax: values[fieldIndexes.IBVMax], // 20
            MeasuredAmpsMax: values[fieldIndexes.MeasuredAmpsMax],
            RPMMax: values[fieldIndexes.RPMMax], // 22
            SoC_percent: values[fieldIndexes.SoC_percent],
            EngineRunTime: values[fieldIndexes.EngineRunTime],
            EngineCycles: values[fieldIndexes.EngineCycles],
            AlternatorOnTime: values[fieldIndexes.AlternatorOnTime],
            AlternatorFuelUsed: values[fieldIndexes.AlternatorFuelUsed],
            ChargedEnergy: values[fieldIndexes.ChargedEnergy],
            DischargedEnergy: values[fieldIndexes.DischargedEnergy],
            AlternatorChargedEnergy: values[fieldIndexes.AlternatorChargedEnergy],
            MaxAlternatorTemperatureF: values[fieldIndexes.MaxAlternatorTemperatureF],
            TemperatureLimitF: values[fieldIndexes.TemperatureLimitF],
            FullChargeVoltage: values[fieldIndexes.FullChargeVoltage],
            TargetAmps: values[fieldIndexes.TargetAmps],
            TargetFloatVoltage: values[fieldIndexes.TargetFloatVoltage],
            SwitchingFrequency: values[fieldIndexes.SwitchingFrequency],
            interval: values[fieldIndexes.interval],
            FieldAdjustmentinterval: values[fieldIndexes.FieldAdjustmentinterval],
            ManualDuty: values[fieldIndexes.ManualDuty],
            SwitchControlOverride: values[fieldIndexes.SwitchControlOverride],
            OnOff: values[fieldIndexes.OnOff],
            ManualFieldToggle: values[fieldIndexes.ManualFieldToggle],
            HiLow: values[fieldIndexes.HiLow],
            LimpHome: values[fieldIndexes.LimpHome],
            VeData: values[fieldIndexes.VeData],
            NMEA0183Data: values[fieldIndexes.NMEA0183Data],
            NMEA2KData: values[fieldIndexes.NMEA2KData],
            TargetAmpL: values[fieldIndexes.TargetAmpL],
            CurrentThreshold: values[fieldIndexes.CurrentThreshold],
            PeukertExponent: values[fieldIndexes.PeukertExponent],
            ChargeEfficiency: values[fieldIndexes.ChargeEfficiency],
            ChargedVoltage: values[fieldIndexes.ChargedVoltage],
            TailCurrent: values[fieldIndexes.TailCurrent],
            ChargedDetectionTime: values[fieldIndexes.ChargedDetectionTime],
            IgnoreTemperature: values[fieldIndexes.IgnoreTemperature],
            BMSLogic: values[fieldIndexes.BMSLogic],
            BMSLogicLevelOff: values[fieldIndexes.BMSLogicLevelOff],
            AlarmActivate: values[fieldIndexes.AlarmActivate],
            TempAlarm: values[fieldIndexes.TempAlarm],
            VoltageAlarmHigh: values[fieldIndexes.VoltageAlarmHigh],
            VoltageAlarmLow: values[fieldIndexes.VoltageAlarmLow],
            CurrentAlarmHigh: values[fieldIndexes.CurrentAlarmHigh],
            FourWay: values[fieldIndexes.FourWay],
            RPMScalingFactor: values[fieldIndexes.RPMScalingFactor],
            ResetTemp: values[fieldIndexes.ResetTemp],
            ResetVoltage: values[fieldIndexes.ResetVoltage],
            ResetCurrent: values[fieldIndexes.ResetCurrent],
            ResetEngineRunTime: values[fieldIndexes.ResetEngineRunTime],
            ResetAlternatorOnTime: values[fieldIndexes.ResetAlternatorOnTime],
            ResetEnergy: values[fieldIndexes.ResetEnergy],
            MaximumAllowedBatteryAmps: values[fieldIndexes.MaximumAllowedBatteryAmps],
            ManualSOCPoint: values[fieldIndexes.ManualSOCPoint],
            BatteryVoltageSource: values[fieldIndexes.BatteryVoltageSource],
            AmpControlByRPM: values[fieldIndexes.AmpControlByRPM],
            RPM1: values[fieldIndexes.RPM1],
            RPM2: values[fieldIndexes.RPM2],
            RPM3: values[fieldIndexes.RPM3],
            RPM4: values[fieldIndexes.RPM4],
            Amps1: values[fieldIndexes.Amps1],
            Amps2: values[fieldIndexes.Amps2],
            Amps3: values[fieldIndexes.Amps3],
            Amps4: values[fieldIndexes.Amps4],
            RPM5: values[fieldIndexes.RPM5],
            RPM6: values[fieldIndexes.RPM6],
            RPM7: values[fieldIndexes.RPM7],
            Amps5: values[fieldIndexes.Amps5],
            Amps6: values[fieldIndexes.Amps6],
            Amps7: values[fieldIndexes.Amps7],
            ShuntResistanceMicroOhm: values[fieldIndexes.ShuntResistanceMicroOhm],
            InvertAltAmps: values[fieldIndexes.InvertAltAmps],
            InvertBattAmps: values[fieldIndexes.InvertBattAmps],
            MaxDuty: values[fieldIndexes.MaxDuty],
            MinDuty: values[fieldIndexes.MinDuty],
            FieldResistance: values[fieldIndexes.FieldResistance],
            maxPoints: values[fieldIndexes.maxPoints],
            AlternatorCOffset: values[fieldIndexes.AlternatorCOffset],
            BatteryCOffset: values[fieldIndexes.BatteryCOffset],
            BatteryCapacity_Ah: values[fieldIndexes.BatteryCapacity_Ah],
            AmpSrc: values[fieldIndexes.AmpSrc],
            R_fixed: values[fieldIndexes.R_fixed],
            Beta: values[fieldIndexes.Beta],
            T0_C: values[fieldIndexes.T0_C],
            TempSource: values[fieldIndexes.TempSource],
            IgnitionOverride: values[fieldIndexes.IgnitionOverride],
            temperatureThermistor: values[fieldIndexes.temperatureThermistor],
            MaxTemperatureThermistor: values[fieldIndexes.MaxTemperatureThermistor],
            VictronCurrent: values[fieldIndexes.VictronCurrent]

          };

          window._debugData = data;
          const updateFields = (fieldArray) => {
            for (const [elementId, key] of fieldArray) {
              const el = document.getElementById(elementId);
              if (!el) continue;
              const value = data[key];
              if (value === undefined || isNaN(value)) {
                el.textContent = "—";
                continue;
              }
              // Values scaled by 100 on server (transmitted as integer × 100)
              if (["BatteryV", "Channel3V", "IBV", "VictronVoltage", "vvout", "FullChargeVoltage", "VictronCurrent",
                "TargetFloatVoltage", "IBVMax", "Bcur", "MeasuredAmps", "MeasuredAmpsMax", "SoC_percent", "AlternatorCOffset", "BatteryCOffset", "R_fixed", "Beta", "T0_C"].includes(key)) {
                el.textContent = (value / 100).toFixed(2);
              }
              // Values scaled by 10 on server (transmitted as integer × 10)  
              else if (["iiout"].includes(key)) {
                el.textContent = (value / 10).toFixed(1);
              }
              // Keep existing scaling for MeasuredAmps and MeasuredAmpsMax (confirmed working)
              // No changes needed here - current display is correct
              // Energy values - transmitted as integer Wh (no scaling needed)
              else if (["ChargedEnergy", "DischargedEnergy", "AlternatorChargedEnergy"].includes(key)) {
                el.textContent = value;  // Display as-is (integer Wh)
              }
              // Fuel in mL - transmitted as integer mL, display as L with decimals
              else if (["AlternatorFuelUsed"].includes(key)) {
                el.textContent = (value / 1000).toFixed(3);  // Convert mL to L with 3 decimal places
              }
              // Time values - convert seconds to H:M:S format
              else if (["EngineRunTime", "AlternatorOnTime"].includes(key)) {
                const totalSeconds = value;  // Changed from totalMinutes
                const hours = Math.floor(totalSeconds / 3600);  // 3600 seconds per hour
                const minutes = Math.floor((totalSeconds % 3600) / 60);  // Remaining seconds to minutes
                const seconds = totalSeconds % 60;  // Remaining seconds
                el.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
              }
              // Settings echo values that need scaling
              else if (["TargetAmps", "TargetAmpL"].includes(key)) {
                el.textContent = value;  // These are not scaled - transmitted as integer amps
              }
              // Default: display as integer
              else {
                el.textContent = Math.round(value);
              }
            }
          };

          updateFields(telemetryFields);  // only visible span updates

          // Update echo elements
          if ('TemperatureLimitF' in data) {
            document.getElementById('TemperatureLimitF_echo').textContent = data.TemperatureLimitF;
          }
          if ('FullChargeVoltage' in data) {
            document.getElementById('FullChargeVoltage_echo').textContent = (data.FullChargeVoltage / 100).toFixed(2);
          }
          if ('TargetAmps' in data) {
            document.getElementById('TargetAmps_echo').textContent = data.TargetAmps;
          }
          if ('TargetFloatVoltage' in data) {
            document.getElementById('TargetFloatVoltage_echo').textContent = (data.TargetFloatVoltage / 100).toFixed(2);
          }
          if ('SwitchingFrequency' in data) {
            document.getElementById('SwitchingFrequency_echo').textContent = data.SwitchingFrequency;
          }
          if ('interval' in data) {
            document.getElementById('interval_echo').textContent = (data.interval / 100).toFixed(3);
          }
          if ('FieldAdjustmentinterval' in data) {
            document.getElementById('FieldAdjustmentinterval_echo').textContent = (data.FieldAdjustmentinterval / 100).toFixed(2);
          }
          if ('ManualDuty' in data) {
            document.getElementById('ManualDuty_echo').textContent = data.ManualDuty;
          }
          if ('SwitchControlOverride' in data) {
            document.getElementById('SwitchControlOverride_echo').textContent = data.SwitchControlOverride;
          }
          if ('OnOff' in data) {
            document.getElementById('OnOff_echo').textContent = data.OnOff;
          }
          if ('ManualFieldToggle' in data) {
            document.getElementById('ManualFieldToggle_echo').textContent = data.ManualFieldToggle;
          }
          if ('HiLow' in data) {
            document.getElementById('HiLow_echo').textContent = data.HiLow;
          }
          if ('LimpHome' in data) {
            document.getElementById('LimpHome_echo').textContent = data.LimpHome;
          }
          if ('VeData' in data) {
            document.getElementById('VeData_echo').textContent = data.VeData;
          }
          if ('NMEA0183Data' in data) {
            document.getElementById('NMEA0183Data_echo').textContent = data.NMEA0183Data;
          }
          if ('NMEA2KData' in data) {
            document.getElementById('NMEA2KData_echo').textContent = data.NMEA2KData;
          }
          if ('TargetAmpL' in data) {
            document.getElementById('TargetAmpL_echo').textContent = data.TargetAmpL;
          }
          if ('CurrentThreshold' in data) {
            document.getElementById('CurrentThreshold_echo').textContent = data.CurrentThreshold;
          }
          if ('PeukertExponent' in data) {
            document.getElementById('PeukertExponent_echo').textContent = (data.PeukertExponent / 100).toFixed(2);
          }
          if ('ChargeEfficiency' in data) {
            document.getElementById('ChargeEfficiency_echo').textContent = data.ChargeEfficiency + '%';
          }
          if ('ChargedVoltage' in data) {
            document.getElementById('ChargedVoltage_echo').textContent = (data.ChargedVoltage / 100).toFixed(2);
          }
          if ('TailCurrent' in data) {
            document.getElementById('TailCurrent_echo').textContent = data.TailCurrent;
          }
          if ('ChargedDetectionTime' in data) {
            document.getElementById('ChargedDetectionTime_echo').textContent = data.ChargedDetectionTime;
          }
          if ('IgnoreTemperature' in data) {
            document.getElementById('IgnoreTemperature_echo').textContent = data.IgnoreTemperature;
          }
          if ('BMSLogic' in data) {
            document.getElementById('BMSLogic_echo').textContent = data.BMSLogic;
          }
          if ('BMSLogicLevelOff' in data) {
            document.getElementById('BMSLogicLevelOff_echo').textContent = data.BMSLogicLevelOff;
          }
          if ('AlarmActivate' in data) {
            document.getElementById('AlarmActivate_echo').textContent = data.AlarmActivate;
          }
          if ('TempAlarm' in data) {
            document.getElementById('TempAlarm_echo').textContent = data.TempAlarm;
          }
          if ('VoltageAlarmHigh' in data) {
            document.getElementById('VoltageAlarmHigh_echo').textContent = data.VoltageAlarmHigh;
          }
          if ('VoltageAlarmLow' in data) {
            document.getElementById('VoltageAlarmLow_echo').textContent = data.VoltageAlarmLow;
          }
          if ('CurrentAlarmHigh' in data) {
            document.getElementById('CurrentAlarmHigh_echo').textContent = data.CurrentAlarmHigh;
          }
          if ('FourWay' in data) {
            document.getElementById('FourWay_echo').textContent = data.FourWay;
          }
          if ('RPMScalingFactor' in data) {
            document.getElementById('RPMScalingFactor_echo').textContent = data.RPMScalingFactor;
          }
          if ('ResetTemp' in data) {
            document.getElementById('ResetTemp_echo').textContent = data.ResetTemp;
          }
          if ('ResetVoltage' in data) {
            document.getElementById('ResetVoltage_echo').textContent = data.ResetVoltage;
          }
          if ('ResetCurrent' in data) {
            document.getElementById('ResetCurrent_echo').textContent = data.ResetCurrent;
          }
          if ('ResetEngineRunTime' in data) {
            document.getElementById('ResetEngineRunTime_echo').textContent = data.ResetEngineRunTime;
          }
          if ('ResetAlternatorOnTime' in data) {
            document.getElementById('ResetAlternatorOnTime_echo').textContent = data.ResetAlternatorOnTime;
          }
          if ('ResetEnergy' in data) {
            document.getElementById('ResetEnergy_echo').textContent = data.ResetEnergy;
          }
          if ('MaximumAllowedBatteryAmps' in data) {
            document.getElementById('MaximumAllowedBatteryAmps_echo').textContent = (data.MaximumAllowedBatteryAmps);
          }
          if ('ManualSOCPoint' in data) {
            document.getElementById('ManualSOCPoint_echo').textContent = data.ManualSOCPoint;
          }

          if ('BatteryVoltageSource' in data) {
            document.getElementById('BatteryVoltageSource_echo').textContent = data.BatteryVoltageSource;
          }
          if ('AmpControlByRPM' in data) {
            document.getElementById('AmpControlByRPM_echo').textContent = data.AmpControlByRPM;
          }
          if ('RPM1' in data) {
            document.getElementById('RPM1_echo').textContent = data.RPM1;
          }
          if ('RPM2' in data) {
            document.getElementById('RPM2_echo').textContent = data.RPM2;
          }
          if ('RPM3' in data) {
            document.getElementById('RPM3_echo').textContent = data.RPM3;
          }
          if ('RPM4' in data) {
            document.getElementById('RPM4_echo').textContent = data.RPM4;
          }
          if ('Amps1' in data) {
            document.getElementById('Amps1_echo').textContent = data.Amps1;
          }
          if ('Amps2' in data) {
            document.getElementById('Amps2_echo').textContent = data.Amps2;
          }
          if ('Amps3' in data) {
            document.getElementById('Amps3_echo').textContent = data.Amps3;
          }
          if ('Amps4' in data) {
            document.getElementById('Amps4_echo').textContent = data.Amps4;
          }
          if ('RPM5' in data) {
            document.getElementById('RPM5_echo').textContent = data.RPM5;
          }
          if ('RPM6' in data) {
            document.getElementById('RPM6_echo').textContent = data.RPM6;
          }
          if ('RPM7' in data) {
            document.getElementById('RPM7_echo').textContent = data.RPM7;
          }
          if ('Amps5' in data) {
            document.getElementById('Amps5_echo').textContent = data.Amps5;
          }
          if ('Amps6' in data) {
            document.getElementById('Amps6_echo').textContent = data.Amps6;
          }
          if ('Amps7' in data) {
            document.getElementById('Amps7_echo').textContent = data.Amps7;
          }
          if ('ShuntResistanceMicroOhm' in data) {
            document.getElementById('ShuntResistanceMicroOhm_echo').textContent = data.ShuntResistanceMicroOhm;
          }
          if ('InvertAltAmps' in data) {
            document.getElementById('InvertAltAmps_echo').textContent = data.InvertAltAmps;
          }
          if ('InvertBattAmps' in data) {
            document.getElementById('InvertBattAmps_echo').textContent = data.InvertBattAmps;
          }
          if ('MaxDuty' in data) {
            document.getElementById('MaxDuty_echo').textContent = data.MaxDuty;
          }
          if ('MinDuty' in data) {
            document.getElementById('MinDuty_echo').textContent = data.MinDuty;
          }
          if ('FieldResistance' in data) {
            document.getElementById('FieldResistance_echo').textContent = data.FieldResistance;
          }
          if ('maxPoints' in data) {
            document.getElementById('maxPoints_echo').textContent = data.maxPoints;
          }
          if ('AlternatorCOffset' in data) {
            document.getElementById('AlternatorCOffset_echo').textContent = (data.AlternatorCOffset / 100).toFixed(2);
          }
          if ('BatteryCOffset' in data) {
            document.getElementById('BatteryCOffset_echo').textContent = (data.BatteryCOffset / 100).toFixed(2);
          }
          if ('BatteryCapacity_Ah' in data) {
            document.getElementById('BatteryCapacity_Ah_echo').textContent = data.BatteryCapacity_Ah;
          }

          if ('R_fixed' in data) {
            document.getElementById('R_fixed_echo').textContent = (data.R_fixed / 100).toFixed(2);
          }
          if ('Beta' in data) {
            document.getElementById('Beta_echo').textContent = (data.Beta / 100).toFixed(2);
          }
          if ('T0_C' in data) {
            document.getElementById('T0_C_echo').textContent = (data.T0_C / 100).toFixed(2);
          }
          if ('TempSource' in data) {
            document.getElementById('TempSource_echo').textContent = data.TempSource;
          }
          if ('IgnitionOverride' in data) {
            document.getElementById('IgnitionOverride_echo').textContent = data.IgnitionOverride;
          }
          if ('AmpSrc' in data) {
            document.getElementById('AmpSrc_echo').textContent = data.AmpSrc;
          }


          // Initialize RPM/Amps fields once on page load
          if (!rpmAmpsInitialized) {
            const rpmAmpFields = [
              { name: "RPM1", id: "RPM1_input" },
              { name: "RPM2", id: "RPM2_input" },
              { name: "RPM3", id: "RPM3_input" },
              { name: "RPM4", id: "RPM4_input" },
              { name: "Amps1", id: "Amps1_input" },
              { name: "Amps2", id: "Amps2_input" },
              { name: "Amps3", id: "Amps3_input" },
              { name: "Amps4", id: "Amps4_input" },
              { name: "RPM5", id: "RPM5_input" },
              { name: "RPM6", id: "RPM6_input" },
              { name: "RPM7", id: "RPM7_input" },
              { name: "Amps5", id: "Amps5_input" },
              { name: "Amps6", id: "Amps6_input" },
              { name: "Amps7", id: "Amps7_input" }
            ];

            // Check if we have received actual data from ESP32 (not just initial zeros)
            let hasValidData = false;
            for (const field of rpmAmpFields) {
              if (data[field.name] !== undefined && data[field.name] > 0) {
                hasValidData = true;
                break;
              }
            }

            // Only initialize if we have real data from ESP32, or this is the first data packet
            if (hasValidData || data.AlternatorTemperatureF !== undefined) {
              for (const field of rpmAmpFields) {
                const inputEl = document.getElementById(field.id);
                if (inputEl && data[field.name] !== undefined) {
                  inputEl.value = data[field.name];
                }
              }
              rpmAmpsInitialized = true;
            }
          }

          const now = Math.floor(Date.now() / 1000);

          updateTogglesFromData(data); // update toggle switches

          // something to do with grayed out settings
          if (currentAdminPassword === "") {
            document.getElementById('settings-section').classList.add("locked");
          }

          // Update Current & Temperature plot data arrays
          if (typeof currentTempPlot !== 'undefined') {
            const battCurrent = 'Bcur' in data ? parseFloat(data.Bcur) / 100 : null;
            const altCurrent = 'MeasuredAmps' in data ? parseFloat(data.MeasuredAmps) / 100 : null;
            const fieldCurrent = 'iiout' in data ? parseFloat(data.iiout) / 10 : null;
            const altTemp = 'AlternatorTemperatureF' in data ? parseFloat(data.AlternatorTemperatureF) : null;

            currentTempData[0].push(now);
            currentTempData[1].push(battCurrent);
            currentTempData[2].push(altCurrent);
            currentTempData[3].push(fieldCurrent);
            currentTempData[4].push(altTemp);

            const currentMaxPoints = data.maxPoints || 40;
            if (currentTempData[0].length > currentMaxPoints) {
              currentTempData[0].shift();
              currentTempData[1].shift();
              currentTempData[2].shift();
              currentTempData[3].shift();
              currentTempData[4].shift();
            }
          }

          // Update Voltage plot data arrays
          if (typeof voltagePlot !== 'undefined') {
            const adsBattV = 'BatteryV' in data ? parseFloat(data.BatteryV) / 100 : null;
            const victronBattV = 'VictronVoltage' in data ? parseFloat(data.VictronVoltage) / 100 : null;
            const inaBattV = 'IBV' in data ? parseFloat(data.IBV) / 100 : null;

            voltageData[0].push(now);
            voltageData[1].push(adsBattV);
            voltageData[2].push(victronBattV);
            voltageData[3].push(inaBattV);

            const currentMaxPoints = data.maxPoints || 40;
            if (voltageData[0].length > currentMaxPoints) {
              voltageData[0].shift();
              voltageData[1].shift();
              voltageData[2].shift();
              voltageData[3].shift();
            }
          }

          // Update RPM plot data arrays
          if (typeof rpmPlot !== 'undefined') {
            const rpmValue = 'RPM' in data ? parseFloat(data.RPM) : null;

            rpmData[0].push(now);
            rpmData[1].push(rpmValue);

            const currentMaxPoints = data.maxPoints || 40;
            if (rpmData[0].length > currentMaxPoints) {
              rpmData[0].shift();
              rpmData[1].shift();
            }
          }

          // Only update the plots if enough time has passed - now update all three plots
          const nowMs = Date.now();
          if (nowMs - lastPlotUpdate > PLOT_UPDATE_INTERVAL_MS) {
            scheduleCurrentTempPlotUpdate();
            scheduleVoltagePlotUpdate();
            scheduleRPMPlotUpdate();

            // Add connection status check here - it will run once per second with your other updates
            const timeSinceLastEvent = nowMs - lastEventTime;
            if (timeSinceLastEvent > 5000) { // 5 seconds without new data = disconnected
              updateInlineStatus(false);
            } else {
              updateInlineStatus(true);
            }

            lastPlotUpdate = nowMs;
          }
        }, false);
      }

      // uplot plot minor details like dark mode and gentle space
      function updateUplotTheme(plot) {
        const textColor = getComputedStyle(document.body).getPropertyValue('--text-dark').trim();
        const gridColor = getComputedStyle(document.body).getPropertyValue('--border').trim();
        // Update axis label divs
        plot.root.querySelectorAll('.u-label').forEach(el => {
          el.style.color = textColor;
        });
        // Update tick label text (SVG)
        plot.root.querySelectorAll('.u-axis text').forEach(el => {
          el.setAttribute('fill', textColor);
        });
        // Update axis strokes (SVG)
        plot.root.querySelectorAll('.u-axis path').forEach(el => {
          el.setAttribute('stroke', textColor);
        });
        // Update grid lines (SVG)
        plot.root.querySelectorAll('.u-grid line').forEach(el => {
          el.setAttribute('stroke', gridColor);
        });
      }

      // Improve legend appearance with clean lines and responsive spacing
      const style = document.createElement('style');
      style.textContent = `
  .u-legend {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 10px;
    max-width: 100%;
    box-sizing: border-box;
  }

  .u-legend .u-series {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .u-legend .u-marker {
    display: inline-block;
    width: 18px;
    height: 3px;
    background-color: currentColor;
    border-radius: 1px;
  }

  .plot-container {
    padding: 10px;
    box-sizing: border-box;
  }

  @media (max-width: 768px) {
    .plot-container {
      padding: 5px;
    }
  }
`;
      document.head.appendChild(style);

      // Initialize toggle states on page load
      document.getElementById("ManualFieldToggle_checkbox").checked = (document.getElementById("ManualFieldToggle").value === "1");
      document.getElementById("SwitchControlOverride_checkbox").checked = (document.getElementById("SwitchControlOverride").value === "1");
      document.getElementById("OnOff_checkbox").checked = (document.getElementById("OnOff").value === "1");
      document.getElementById("LimpHome_checkbox").checked = (document.getElementById("LimpHome").value === "1");
      document.getElementById("HiLow_checkbox").checked = (document.getElementById("HiLow").value === "1");
      document.getElementById("VeData_checkbox").checked = (document.getElementById("VeData").value === "1");
      document.getElementById("NMEA0183Data_checkbox").checked = (document.getElementById("NMEA0183Data").value === "1");
      document.getElementById("NMEA2KData_checkbox").checked = (document.getElementById("NMEA2KData").value === "1");
      document.getElementById("IgnoreTemperature_checkbox").checked = (document.getElementById("IgnoreTemperature").value === "1");
      document.getElementById("BMSLogic_checkbox").checked = (document.getElementById("BMSLogic").value === "1");
      document.getElementById("BMSLogicLevelOff_checkbox").checked = (document.getElementById("BMSLogicLevelOff").value === "1");
      document.getElementById("AlarmActivate_checkbox").checked = (document.getElementById("AlarmActivate").value === "1");
      document.getElementById("AmpControlByRPM_checkbox").checked = (document.getElementById("AmpControlByRPM").value === "1");
      document.getElementById("InvertAltAmps_checkbox").checked = (document.getElementById("InvertAltAmps").value === "1");
      document.getElementById("InvertBattAmps_checkbox").checked = (document.getElementById("InvertBattAmps").value === "1");
      document.getElementById("IgnitionOverride_checkbox").checked = (document.getElementById("IgnitionOverride").value === "1");
      document.getElementById("TempSource_checkbox").checked = (document.getElementById("TempSource").value === "1");

      document.getElementById("admin_password").addEventListener("change", updatePasswordFields);
    }); // ← ADD THIS LINE

  </script>

  <div id="corner-status" class="corner-status corner-status-connected">CONNECTED</div>

  <!-- Hidden fallback elements to satisfy JavaScript field lookups DELETE THIS HACK JOB SOMEDAY -->
  <div style="display:none;">
    <!-- Echo display spans -->
    <span id="RPMMaxID" style="display:none;">0</span>
    <span id="SoC_percentID" style="display:none;">0</span>
    <span id="EngineRunTimeID" style="display:none;">0</span>
    <span id="EngineCyclesID" style="display:none;">0</span>
    <span id="AlternatorOnTimeID" style="display:none;">0</span>
    <span id="AlternatorFuelUsedID" style="display:none;">0</span>
    <span id="ChargedEnergyID" style="display:none;">0</span>
    <span id="DischargedEnergyID" style="display:none;">0</span>
    <span id="AlternatorChargedEnergyID" style="display:none;">0</span>
    <span id="MaxAlternatorTemperatureF_ID" style="display:none;">0</span>

    <!-- Echo spans for settings -->
    <span id="TemperatureLimitF_echo" style="display:none;">0</span>
    <span id="FullChargeVoltage_echo" style="display:none;">0</span>
    <span id="TargetAmps_echo" style="display:none;">0</span>
    <span id="TargetFloatVoltage_echo" style="display:none;">0</span>
    <span id="SwitchingFrequency_echo" style="display:none;">0</span>
    <span id="interval_echo" style="display:none;">0</span>
    <span id="FieldAdjustmentinterval_echo" style="display:none;">0</span>
    <span id="ManualDuty_echo" style="display:none;">0</span>
    <span id="SwitchControlOverride_echo" style="display:none;">0</span>
    <span id="OnOff_echo" style="display:none;">0</span>
    <span id="ManualFieldToggle_echo" style="display:none;">0</span>
    <span id="HiLow_echo" style="display:none;">0</span>
    <span id="LimpHome_echo" style="display:none;">0</span>
    <span id="VeData_echo" style="display:none;">0</span>
    <span id="NMEA0183Data_echo" style="display:none;">0</span>
    <span id="NMEA2KData_echo" style="display:none;">0</span>
    <span id="TargetAmpL_echo" style="display:none;">0</span>
    <span id="CurrentThreshold_echo" style="display:none;">0</span>
    <span id="PeukertExponent_echo" style="display:none;">0</span>
    <span id="ChargeEfficiency_echo" style="display:none;">0</span>
    <span id="ChargedVoltage_echo" style="display:none;">0</span>
    <span id="TailCurrent_echo" style="display:none;">0</span>
    <span id="ChargedDetectionTime_echo" style="display:none;">0</span>
    <span id="IgnoreTemperature_echo" style="display:none;">0</span>
    <span id="BMSLogic_echo" style="display:none;">0</span>
    <span id="BMSLogicLevelOff_echo" style="display:none;">0</span>
    <span id="AlarmActivate_echo" style="display:none;">0</span>
    <span id="TempAlarm_echo" style="display:none;">0</span>
    <span id="VoltageAlarmHigh_echo" style="display:none;">0</span>
    <span id="VoltageAlarmLow_echo" style="display:none;">0</span>
    <span id="CurrentAlarmHigh_echo" style="display:none;">0</span>
    <span id="FourWay_echo" style="display:none;">0</span>
    <span id="RPMScalingFactor_echo" style="display:none;">0</span>
    <span id="ResetTemp_echo" style="display:none;">0</span>
    <span id="ResetVoltage_echo" style="display:none;">0</span>
    <span id="ResetCurrent_echo" style="display:none;">0</span>
    <span id="ResetEngineRunTime_echo" style="display:none;">0</span>
    <span id="ResetAlternatorOnTime_echo" style="display:none;">0</span>
    <span id="ResetEnergy_echo" style="display:none;">0</span>
    <span id="ResetAlternatorChargedEnergy_echo" style="display:none;">0</span>
    <span id="ResetDischargedEnergy_echo" style="display:none;">0</span>
    <span id="ResetFuelUsed_echo" style="display:none;">0</span>
    <span id="ResetEngineCycles_echo" style="display:none;">0</span>
    <span id="ResetRPMMax_echo" style="display:none;">0</span>
    <span id="FuelUsedID" style="display:none;">0</span>
    <span id="MaximumAllowedBatteryAmps_echo" style="display:none;">0</span>
    <span id="ManualSOCPoint_echo" style="display:none;">0</span>
    <span id="BatteryVoltageSource_echo" style="display:none;">0</span>
    <span id="AmpControlByRPM_echo" style="display:none;">0</span>
    <span id="RPM1_echo" style="display:none;">0</span>
    <span id="RPM2_echo" style="display:none;">0</span>
    <span id="RPM3_echo" style="display:none;">0</span>
    <span id="RPM4_echo" style="display:none;">0</span>
    <span id="Amps1_echo" style="display:none;">0</span>
    <span id="Amps2_echo" style="display:none;">0</span>
    <span id="Amps3_echo" style="display:none;">0</span>
    <span id="Amps4_echo" style="display:none;">0</span>
    <span id="RPM5_echo" style="display:none;">0</span>
    <span id="RPM6_echo" style="display:none;">0</span>
    <span id="RPM7_echo" style="display:none;">0</span>
    <span id="Amps5_echo" style="display:none;">0</span>
    <span id="Amps6_echo" style="display:none;">0</span>
    <span id="Amps7_echo" style="display:none;">0</span>
    <span id="ShuntResistanceMicroOhm_echo" style="display:none;">0</span>
    <span id="InvertAltAmps_echo" style="display:none;">0</span>
    <span id="InvertBattAmps_echo" style="display:none;">0</span>
    <span id="MaxDuty_echo" style="display:none;">0</span>
    <span id="MinDuty_echo" style="display:none;">0</span>
    <span id="FieldResistance_echo" style="display:none;">0</span>
    <span id="maxPoints_echo" style="display:none;">0</span>
    <span id="BatteryCOffset_echo" style="display:none;">0</span>
    <span id="AlternatorCOffset_echo" style="display:none;">0</span>
    <span id="BatteryCapacity_Ah_echo" style="display:none;">0</span>
    <span id="AmpSrc_echo" style="display:none;">0</span>
    <span id="R_fixed_echo" style="display:none;">0</span>
    <span id="Beta_echo" style="display:none;">0</span>
    <span id="T0_C_echo" style="display:none;">0</span>
    <span id="TempSource_echo" style="display:none;">0</span>
    <span id="IgnitionOverride_echo" style="display:none;">0</span>
    <span id="TempSource_echo" style="display:none;">0</span>




    <!-- Input values for settings -->
    <input id="TemperatureLimitF" style="display:none;" value="0" />
    <input id="FullChargeVoltage" style="display:none;" value="0" />
    <input id="TargetAmps" style="display:none;" value="0" />
    <input id="TargetFloatVoltage" style="display:none;" value="0" />
    <input id="SwitchingFrequency" style="display:none;" value="0" />
    <input id="interval" style="display:none;" value="0" />
    <input id="FieldAdjustmentinterval" style="display:none;" value="0" />
    <input id="ManualDuty" style="display:none;" value="0" />
    <input id="SwitchControlOverride" style="display:none;" value="0" />
    <input id="OnOff" style="display:none;" value="0" />
    <input id="ManualFieldToggle" style="display:none;" value="0" />
    <input id="HiLow" style="display:none;" value="0" />
    <input id="LimpHome" style="display:none;" value="0" />
    <input id="VeData" style="display:none;" value="0" />
    <input id="NMEA0183Data" style="display:none;" value="0" />
    <input id="NMEA2KData" style="display:none;" value="0" />
    <input id="TargetAmpL" style="display:none;" value="0" />
    <input id="CurrentThreshold" style="display:none;" value="0" />
    <input id="PeukertExponent" style="display:none;" value="0" />
    <input id="ChargeEfficiency" style="display:none;" value="0" />
    <input id="ChargedVoltage" style="display:none;" value="0" />
    <input id="TailCurrent" style="display:none;" value="0" />
    <input id="ChargedDetectionTime" style="display:none;" value="0" />
    <input id="IgnoreTemperature" style="display:none;" value="0" />
    <input id="BMSLogic" style="display:none;" value="0" />
    <input id="BMSLogicLevelOff" style="display:none;" value="0" />
    <input id="AlarmActivate" style="display:none;" value="0" />
    <input id="TempAlarm" style="display:none;" value="0" />
    <input id="VoltageAlarmHigh" style="display:none;" value="0" />
    <input id="VoltageAlarmLow" style="display:none;" value="0" />
    <input id="CurrentAlarmHigh" style="display:none;" value="0" />
    <input id="FourWay" style="display:none;" value="0" />
    <input id="RPMScalingFactor" style="display:none;" value="0" />
    <input id="ResetTemp" style="display:none;" value="0" />
    <input id="ResetVoltage" style="display:none;" value="0" />
    <input id="ResetCurrent" style="display:none;" value="0" />
    <input id="ResetEngineRunTime" style="display:none;" value="0" />
    <input id="ResetAlternatorOnTime" style="display:none;" value="0" />
    <input id="ResetEnergy" style="display:none;" value="0" />
    <input id="ResetAlternatorChargedEnergy" style="display:none;" value="0" />
    <input id="ResetDischargedEnergy" style="display:none;" value="0" />
    <input id="ResetFuelUsed" style="display:none;" value="0" />
    <input id="ResetEngineCycles" style="display:none;" value="0" />
    <input id="ResetRPMMax" style="display:none;" value="0" />
    <input id="MaximumAllowedBatteryAmps" style="display:none;" value="0" />
    <input id="ManualSOCPoint" style="display:none;" value="0" />
    <input id="BatteryVoltageSource" style="display:none;" value="0" />
    <input id="AmpSrc" style="display:none;" value="0" />
    <input id="AmpControlByRPM" style="display:none;" value="0" />
    <input id="RPM1" style="display:none;" value="0" />
    <input id="RPM2" style="display:none;" value="0" />
    <input id="RPM3" style="display:none;" value="0" />
    <input id="RPM4" style="display:none;" value="0" />
    <input id="Amps1" style="display:none;" value="0" />
    <input id="Amps2" style="display:none;" value="0" />
    <input id="Amps3" style="display:none;" value="0" />
    <input id="Amps4" style="display:none;" value="0" />
    <input id="RPM5" style="display:none;" value="0" />
    <input id="RPM6" style="display:none;" value="0" />
    <input id="RPM7" style="display:none;" value="0" />
    <input id="Amps5" style="display:none;" value="0" />
    <input id="Amps6" style="display:none;" value="0" />
    <input id="Amps7" style="display:none;" value="0" />
    <input id="ShuntResistanceMicroOhm" style="display:none;" value="0" />
    <input id="InvertAltAmps" style="display:none;" value="0" />
    <input id="InvertBattAmps" style="display:none;" value="0" />
    <input id="MaxDuty" style="display:none;" value="0" />
    <input id="MinDuty" style="display:none;" value="0" />
    <input id="FieldResistance" style="display:none;" value="0" />
    <input id="maxPoints" style="display:none;" value="0" />
    <input id="AlternatorCOffset" style="display:none;" value="0" />
    <input id="BatteryCOffset" style="display:none;" value="0" />
    <input id="BatteryCapacity_Ah" style="display:none;" value="0" />
    <input id="R_fixed" style="display:none;" value="0" />
    <input id="Beta" style="display:none;" value="0" />
    <input id="T0_C" style="display:none;" value="0" />
    <input id="TempSource" style="display:none;" value="0" />
    <input id="IgnitionOverride" style="display:none;" value="0" />
    <input id="TempSource" style="display:none;" value="0" />



  </div>
</body>

</html>
